---
title: 'Population density affects sexual selection in an insect model'
author: "Lennart Winkler^1^, Ronja Eilhardt^1^ & Tim Janicke^1,2^ <br></br>  ^1^Applied Zoology, Technical University Dresden <br> ^2^Centre d’Écologie Fonctionnelle et Évolutive, UMR 5175, CNRS, Université de Montpellier</br>"
subtitle: 'Part 3: Sexual selection metrics'
site: workflowr::wflow_site
output:
  workflowr::wflow_html
---

Supplementary material reporting R code for the manuscript 'Population density affects sexual selection in an insect model'.

# Part 3: Sexual selection metrics

We computed standardized metrics of (sexual) selection and tested for differences among density treatments and sexes, including the standardized mating and selection differential (m’ and s’, respectively) on body mass, a trait that is likely under sexual and natural selection. To this end, we relativized all traits within sex and treatment by dividing each observed value by the mean value of that sex and treatment. We then used bootstrapping to estimate the different selection metrics and to compare them between treatments (see details above). Throughout, for treatment comparisons we subtracted the low density treatment (i.e. small group or large arena size) from the high density treatment (i.e. large group or small arena size), hence negative differences indicate larger values at lower density and positive differences larger values at higher density. Hereafter we will refer to the difference between treatments as ‘effect size’.

# Load and prepare data

Before we started the analyses, we loaded all necessary packages and data. 

```{r , message=FALSE, warning=FALSE, results='hide'}
rm(list = ls()) # Clear work environment

# Load R-packages ####
list_of_packages=cbind('ggeffects','ggplot2','gridExtra','lme4','lmerTest','readr','dplyr','EnvStats','cowplot','gridGraphics','car','RColorBrewer','boot','data.table','base','ICC','knitr')
lapply(list_of_packages, require, character.only = TRUE) 

# Load data set ####
D_data=read_delim("./data/Data_Winkler_et_al_2023_Denstiy.csv",";", escape_double = FALSE, trim_ws = TRUE)

# Set factors and levels for factors
D_data$Week=as.factor(D_data$Week)
D_data$Sex=as.factor(D_data$Sex)
D_data$Gr_size=as.factor(D_data$Gr_size)
D_data$Gr_size <- factor(D_data$Gr_size, levels=c("SG","LG"))
D_data$Arena=as.factor(D_data$Arena)

## Subset data set ####
### Data according to denstiy ####
D_data_0.26=D_data[D_data$Treatment=='D = 0.26',]
D_data_0.52=D_data[D_data$Treatment=='D = 0.52',]
D_data_0.67=D_data[D_data$Treatment=='D = 0.67',]
D_data_1.33=D_data[D_data$Treatment=='D = 1.33',]

### Subset data by sex ####
D_data_m=D_data[D_data$Sex=='M',]
D_data_f=D_data[D_data$Sex=='F',]

### Calculate data relativized within treatment and sex ####
# Small group + large Area
D_data_0.26=D_data[D_data$Treatment=='D = 0.26',]

D_data_0.26$rel_m_RS=NA
D_data_0.26$rel_m_prop_RS=NA
D_data_0.26$rel_m_cMS=NA
D_data_0.26$rel_m_InSuc=NA
D_data_0.26$rel_m_feSuc=NA
D_data_0.26$rel_m_pFec=NA
D_data_0.26$rel_m_PS=NA
D_data_0.26$rel_m_pFec_compl=NA

D_data_0.26$rel_f_RS=NA
D_data_0.26$rel_f_prop_RS=NA
D_data_0.26$rel_f_cMS=NA
D_data_0.26$rel_f_fec_pMate=NA

D_data_0.26$rel_m_RS=D_data_0.26$m_RS/mean(D_data_0.26$m_RS,na.rm=T)
D_data_0.26$rel_m_prop_RS=D_data_0.26$m_prop_RS/mean(D_data_0.26$m_prop_RS,na.rm=T)
D_data_0.26$rel_m_cMS=D_data_0.26$m_cMS/mean(D_data_0.26$m_cMS,na.rm=T)
D_data_0.26$rel_m_InSuc=D_data_0.26$m_InSuc/mean(D_data_0.26$m_InSuc,na.rm=T)
D_data_0.26$rel_m_feSuc=D_data_0.26$m_feSuc/mean(D_data_0.26$m_feSuc,na.rm=T)
D_data_0.26$rel_m_pFec=D_data_0.26$m_pFec/mean(D_data_0.26$m_pFec,na.rm=T)
D_data_0.26$rel_m_PS=D_data_0.26$m_PS/mean(D_data_0.26$m_PS,na.rm=T)
D_data_0.26$rel_m_pFec_compl=D_data_0.26$m_pFec_compl/mean(D_data_0.26$m_pFec_compl,na.rm=T)

D_data_0.26$rel_f_RS=D_data_0.26$f_RS/mean(D_data_0.26$f_RS,na.rm=T)
D_data_0.26$rel_f_prop_RS=D_data_0.26$f_prop_RS/mean(D_data_0.26$f_prop_RS,na.rm=T)
D_data_0.26$rel_f_cMS=D_data_0.26$f_cMS/mean(D_data_0.26$f_cMS,na.rm=T)
D_data_0.26$rel_f_fec_pMate=D_data_0.26$f_fec_pMate/mean(D_data_0.26$f_fec_pMate,na.rm=T)

# Large group + large Area
D_data_0.52=D_data[D_data$Treatment=='D = 0.52',]
#Relativize data

D_data_0.52$rel_m_RS=NA
D_data_0.52$rel_m_prop_RS=NA
D_data_0.52$rel_m_cMS=NA
D_data_0.52$rel_m_InSuc=NA
D_data_0.52$rel_m_feSuc=NA
D_data_0.52$rel_m_pFec=NA
D_data_0.52$rel_m_PS=NA
D_data_0.52$rel_m_pFec_compl=NA

D_data_0.52$rel_f_RS=NA
D_data_0.52$rel_f_prop_RS=NA
D_data_0.52$rel_f_cMS=NA
D_data_0.52$rel_f_fec_pMate=NA

D_data_0.52$rel_m_RS=D_data_0.52$m_RS/mean(D_data_0.52$m_RS,na.rm=T)
D_data_0.52$rel_m_prop_RS=D_data_0.52$m_prop_RS/mean(D_data_0.52$m_prop_RS,na.rm=T)
D_data_0.52$rel_m_cMS=D_data_0.52$m_cMS/mean(D_data_0.52$m_cMS,na.rm=T)
D_data_0.52$rel_m_InSuc=D_data_0.52$m_InSuc/mean(D_data_0.52$m_InSuc,na.rm=T)
D_data_0.52$rel_m_feSuc=D_data_0.52$m_feSuc/mean(D_data_0.52$m_feSuc,na.rm=T)
D_data_0.52$rel_m_pFec=D_data_0.52$m_pFec/mean(D_data_0.52$m_pFec,na.rm=T)
D_data_0.52$rel_m_PS=D_data_0.52$m_PS/mean(D_data_0.52$m_PS,na.rm=T)
D_data_0.52$rel_m_pFec_compl=D_data_0.52$m_pFec_compl/mean(D_data_0.52$m_pFec_compl,na.rm=T)

D_data_0.52$rel_f_RS=D_data_0.52$f_RS/mean(D_data_0.52$f_RS,na.rm=T)
D_data_0.52$rel_f_prop_RS=D_data_0.52$f_prop_RS/mean(D_data_0.52$f_prop_RS,na.rm=T)
D_data_0.52$rel_f_cMS=D_data_0.52$f_cMS/mean(D_data_0.52$f_cMS,na.rm=T)
D_data_0.52$rel_f_fec_pMate=D_data_0.52$f_fec_pMate/mean(D_data_0.52$f_fec_pMate,na.rm=T)

# Small group + small Area
D_data_0.67=D_data[D_data$Treatment=='D = 0.67',]
#Relativize data
D_data_0.67$rel_m_RS=NA
D_data_0.67$rel_m_prop_RS=NA
D_data_0.67$rel_m_cMS=NA
D_data_0.67$rel_m_InSuc=NA
D_data_0.67$rel_m_feSuc=NA
D_data_0.67$rel_m_pFec=NA
D_data_0.67$rel_m_PS=NA
D_data_0.67$rel_m_pFec_compl=NA

D_data_0.67$rel_f_RS=NA
D_data_0.67$rel_f_prop_RS=NA
D_data_0.67$rel_f_cMS=NA
D_data_0.67$rel_f_fec_pMate=NA

D_data_0.67$rel_m_RS=D_data_0.67$m_RS/mean(D_data_0.67$m_RS,na.rm=T)
D_data_0.67$rel_m_prop_RS=D_data_0.67$m_prop_RS/mean(D_data_0.67$m_prop_RS,na.rm=T)
D_data_0.67$rel_m_cMS=D_data_0.67$m_cMS/mean(D_data_0.67$m_cMS,na.rm=T)
D_data_0.67$rel_m_InSuc=D_data_0.67$m_InSuc/mean(D_data_0.67$m_InSuc,na.rm=T)
D_data_0.67$rel_m_feSuc=D_data_0.67$m_feSuc/mean(D_data_0.67$m_feSuc,na.rm=T)
D_data_0.67$rel_m_pFec=D_data_0.67$m_pFec/mean(D_data_0.67$m_pFec,na.rm=T)
D_data_0.67$rel_m_PS=D_data_0.67$m_PS/mean(D_data_0.67$m_PS,na.rm=T)
D_data_0.67$rel_m_pFec_compl=D_data_0.67$m_pFec_compl/mean(D_data_0.67$m_pFec_compl,na.rm=T)

D_data_0.67$rel_f_RS=D_data_0.67$f_RS/mean(D_data_0.67$f_RS,na.rm=T)
D_data_0.67$rel_f_prop_RS=D_data_0.67$f_prop_RS/mean(D_data_0.67$f_prop_RS,na.rm=T)
D_data_0.67$rel_f_cMS=D_data_0.67$f_cMS/mean(D_data_0.67$f_cMS,na.rm=T)
D_data_0.67$rel_f_fec_pMate=D_data_0.67$f_fec_pMate/mean(D_data_0.67$f_fec_pMate,na.rm=T)

# Large group + small Area
D_data_1.33=D_data[D_data$Treatment=='D = 1.33',]
#Relativize data

D_data_1.33$rel_m_RS=NA
D_data_1.33$rel_m_prop_RS=NA
D_data_1.33$rel_m_cMS=NA
D_data_1.33$rel_m_InSuc=NA
D_data_1.33$rel_m_feSuc=NA
D_data_1.33$rel_m_pFec=NA
D_data_1.33$rel_m_PS=NA
D_data_1.33$rel_m_pFec_compl=NA

D_data_1.33$rel_f_RS=NA
D_data_1.33$rel_f_prop_RS=NA
D_data_1.33$rel_f_cMS=NA
D_data_1.33$rel_f_fec_pMate=NA

D_data_1.33$rel_m_RS=D_data_1.33$m_RS/mean(D_data_1.33$m_RS,na.rm=T)
D_data_1.33$rel_m_prop_RS=D_data_1.33$m_prop_RS/mean(D_data_1.33$m_prop_RS,na.rm=T)
D_data_1.33$rel_m_cMS=D_data_1.33$m_cMS/mean(D_data_1.33$m_cMS,na.rm=T)
D_data_1.33$rel_m_InSuc=D_data_1.33$m_InSuc/mean(D_data_1.33$m_InSuc,na.rm=T)
D_data_1.33$rel_m_feSuc=D_data_1.33$m_feSuc/mean(D_data_1.33$m_feSuc,na.rm=T)
D_data_1.33$rel_m_pFec=D_data_1.33$m_pFec/mean(D_data_1.33$m_pFec,na.rm=T)
D_data_1.33$rel_m_PS=D_data_1.33$m_PS/mean(D_data_1.33$m_PS,na.rm=T)
D_data_1.33$rel_m_pFec_compl=D_data_1.33$m_pFec_compl/mean(D_data_1.33$m_pFec_compl,na.rm=T)

D_data_1.33$rel_f_RS=D_data_1.33$f_RS/mean(D_data_1.33$f_RS,na.rm=T)
D_data_1.33$rel_f_prop_RS=D_data_1.33$f_prop_RS/mean(D_data_1.33$f_prop_RS,na.rm=T)
D_data_1.33$rel_f_cMS=D_data_1.33$f_cMS/mean(D_data_1.33$f_cMS,na.rm=T)
D_data_1.33$rel_f_fec_pMate=D_data_1.33$f_fec_pMate/mean(D_data_1.33$f_fec_pMate,na.rm=T)

### Reduce treatments to arena and population size ####
# Arena size
D_data_Large_arena=rbind(D_data_0.26,D_data_0.52)
D_data_Small_arena=rbind(D_data_0.67,D_data_1.33)

# Population size
D_data_Small_pop=rbind(D_data_0.26,D_data_0.67)
D_data_Large_pop=rbind(D_data_0.52,D_data_1.33)

## Set figure schemes ####
# Set color-sets for figures
colpal=brewer.pal(4, 'Dark2')
colpal2=c("#b2182b","#2166AC")
colpal3=brewer.pal(4, 'Paired')

# Set theme for ggplot2 figures
fig_theme=theme(panel.border = element_blank(),
                plot.margin = margin(0,2.2,0,0.2,"cm"),
                plot.title = element_text(hjust = 0.5),
                panel.background = element_blank(),
                legend.key=element_blank(),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(), 
                legend.position = c(1.25, 0.8),
                plot.tag.position=c(0.01,0.98),
                legend.title = element_blank(),
                legend.text = element_text(colour="black", size=10),
                axis.line.x = element_line(colour = "black", size = 1),
                axis.line.y = element_line(colour = "black", size = 1),
                axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
                axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
                axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
                axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
                axis.ticks = element_line(size = 1),
                axis.ticks.length = unit(.3, "cm"))

## Create customized functions for analysis ####
# Create function to calculate standard error and upper/lower standard deviation
standard_error <- function(x) sd(x,na.rm=T) / sqrt(length(na.exclude(x)))
upper_SD <- function(x) mean(x,na.rm=T)+(sd(x)/2)
lower_SD <- function(x) mean(x,na.rm=T)-(sd(x)/2)
```

# Bootastrap (sexual) selection metrics

First, we bootstrapped the different metrics of (sexual) selection.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Bootastrap (sexual) selection metrics ####
### Opportuity for selection (I) ####
# Arena size
D_data_Large_arena_Male_rel_propRS <-as.data.table(D_data_Large_arena$rel_m_RS)
c <- function(d, i){
  d2 <- d[i,]
  return(var(d2[,1], na.rm=TRUE))
}
I_Large_arena_Male_bootvar <- boot(D_data_Large_arena_Male_rel_propRS, c, R=10000)

D_data_Large_arena_Female_rel_propRS <-as.data.table(D_data_Large_arena$rel_f_RS)

I_Large_arena_Female_bootvar <- boot(D_data_Large_arena_Female_rel_propRS, c, R=10000)

D_data_Small_arena_Male_rel_propRS <-as.data.table(D_data_Small_arena$rel_m_RS)

I_Small_arena_Male_bootvar <- boot(D_data_Small_arena_Male_rel_propRS, c, R=10000)

D_data_Small_arena_Female_rel_propRS <-as.data.table(D_data_Small_arena$rel_f_RS)

I_Small_arena_Female_bootvar <- boot(D_data_Small_arena_Female_rel_propRS, c, R=10000)

# Population size
D_data_Large_pop_Male_rel_propRS <-as.data.table(D_data_Large_pop$rel_m_RS)

I_Large_pop_Male_bootvar <- boot(D_data_Large_pop_Male_rel_propRS, c, R=10000)

D_data_Large_pop_Female_rel_propRS <-as.data.table(D_data_Large_pop$rel_f_RS)

I_Large_pop_Female_bootvar <- boot(D_data_Large_pop_Female_rel_propRS, c, R=10000)

D_data_Small_pop_Male_rel_propRS <-as.data.table(D_data_Small_pop$rel_m_RS)

I_Small_pop_Male_bootvar <- boot(D_data_Small_pop_Male_rel_propRS, c, R=10000)

D_data_Small_pop_Female_rel_propRS <-as.data.table(D_data_Small_pop$rel_f_RS)

I_Small_pop_Female_bootvar <- boot(D_data_Small_pop_Female_rel_propRS, c, R=10000)
rm("c")

### Opportunity for sexual selection (Is) ####
# Arena size
D_data_Large_arena_Male_relMS <-as.data.table(D_data_Large_arena$rel_m_cMS)
c <- function(d, i){
  d2 <- d[i,]
  return(var(d2[,1], na.rm=TRUE))
}
Is_Large_arena_Male_bootvar <- boot(D_data_Large_arena_Male_relMS, c, R=10000)

D_data_Large_arena_Female_relMS <-as.data.table(D_data_Large_arena$rel_f_cMS)

Is_Large_arena_Female_bootvar <- boot(D_data_Large_arena_Female_relMS, c, R=10000)

D_data_Small_arena_Male_relMS <-as.data.table(D_data_Small_arena$rel_m_cMS)

Is_Small_arena_Male_bootvar <- boot(D_data_Small_arena_Male_relMS, c, R=10000)

D_data_Small_arena_Female_relMS <-as.data.table(D_data_Small_arena$rel_f_cMS)

Is_Small_arena_Female_bootvar <- boot(D_data_Small_arena_Female_relMS, c, R=10000)

# Population size
D_data_Large_pop_Male_relMS <-as.data.table(D_data_Large_pop$rel_m_cMS)

Is_Large_pop_Male_bootvar <- boot(D_data_Large_pop_Male_relMS, c, R=10000)

D_data_Large_pop_Female_relMS <-as.data.table(D_data_Large_pop$rel_f_cMS)

Is_Large_pop_Female_bootvar <- boot(D_data_Large_pop_Female_relMS, c, R=10000)

D_data_Small_pop_Male_relMS <-as.data.table(D_data_Small_pop$rel_m_cMS)

Is_Small_pop_Male_bootvar <- boot(D_data_Small_pop_Male_relMS, c, R=10000)

D_data_Small_pop_Female_relMS <-as.data.table(D_data_Small_pop$rel_f_cMS)

Is_Small_pop_Female_bootvar <- boot(D_data_Small_pop_Female_relMS, c, R=10000)
rm("c")

### Sexual selection gradient (Bateman gradient) ####
# Arena size
D_data_Large_arena_Male_B <-as.data.table(cbind(D_data_Large_arena$rel_m_RS,D_data_Large_arena$rel_m_cMS))

c <- function(d, i){
  d2 <- d[i,]
  return(lm(V1 ~V2,data=d2)$coefficients[2])
}
B_Large_arena_Male_bootvar <- boot(D_data_Large_arena_Male_B, c, R=10000)

D_data_Small_arena_Male_B <-as.data.table(cbind(D_data_Small_arena$rel_m_RS,D_data_Small_arena$rel_m_cMS))

B_Small_arena_Male_bootvar <- boot(D_data_Small_arena_Male_B, c, R=10000)

D_data_Large_arena_Female_B <-as.data.table(cbind(D_data_Large_arena$rel_f_RS,D_data_Large_arena$rel_f_cMS))

B_Large_arena_Female_bootvar <- boot(D_data_Large_arena_Female_B, c, R=10000)

D_data_Small_arena_Female_B <-as.data.table(cbind(D_data_Small_arena$rel_f_RS,D_data_Small_arena$rel_f_cMS))

B_Small_arena_Female_bootvar <- boot(D_data_Small_arena_Female_B, c, R=10000)

#Population size
D_data_Large_pop_Male_B <-as.data.table(cbind(D_data_Large_pop$rel_m_RS,D_data_Large_pop$rel_m_cMS))

B_Large_pop_Male_bootvar <- boot(D_data_Large_pop_Male_B, c, R=10000)

D_data_Small_pop_Male_B <-as.data.table(cbind(D_data_Small_pop$rel_m_RS,D_data_Small_pop$rel_m_cMS))

B_Small_pop_Male_bootvar <- boot(D_data_Small_pop_Male_B, c, R=10000)

D_data_Large_pop_Female_B <-as.data.table(cbind(D_data_Large_pop$rel_f_RS,D_data_Large_pop$rel_f_cMS))

B_Large_pop_Female_bootvar <- boot(D_data_Large_pop_Female_B, c, R=10000)

D_data_Small_pop_Female_B <-as.data.table(cbind(D_data_Small_pop$rel_f_RS,D_data_Small_pop$rel_f_cMS))

B_Small_pop_Female_bootvar <- boot(D_data_Small_pop_Female_B, c, R=10000)
rm("c")

### Jones index (S) ####
# Arena size
c <- function(d, i){
  d2 <- d[i,]
  return(lm(d2$V1 ~d2$V2)$coefficients[2]*sqrt(var(d2$V2, na.rm=TRUE)))
}

S_Large_arena_Male_bootvar <- boot(D_data_Large_arena_Male_B, c, R=10000)

S_Small_arena_Male_bootvar <- boot(D_data_Small_arena_Male_B, c, R=10000)

S_Large_arena_Female_bootvar <- boot(D_data_Large_arena_Female_B, c, R=10000)

S_Small_arena_Female_bootvar <- boot(D_data_Small_arena_Female_B, c, R=10000)

#Population size
S_Large_pop_Male_bootvar <- boot(D_data_Large_pop_Male_B, c, R=10000)

S_Small_pop_Male_bootvar <- boot(D_data_Small_pop_Male_B, c, R=10000)

S_Large_pop_Female_bootvar <- boot(D_data_Large_pop_Female_B, c, R=10000)

S_Small_pop_Female_bootvar <- boot(D_data_Small_pop_Female_B, c, R=10000)
rm("c")

### Extract data and write results table ####
PhenVarBoot_Table_Male_Small_pop_I <- as.data.frame(cbind("Male", "Small population size", "Opportunity for selection", as.numeric(mean(I_Small_pop_Male_bootvar$t)), quantile(I_Small_pop_Male_bootvar$t,.025, names = FALSE), quantile(I_Small_pop_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Large_pop_I <- as.data.frame(cbind("Male", "Large population size", "Opportunity for selection", mean(I_Large_pop_Male_bootvar$t), quantile(I_Large_pop_Male_bootvar$t,.025, names = FALSE), quantile(I_Large_pop_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Large_arena_I <- as.data.frame(cbind("Male", "Large arena size", "Opportunity for selection", mean(I_Large_arena_Male_bootvar$t), quantile(I_Large_arena_Male_bootvar$t,.025, names = FALSE), quantile(I_Large_arena_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Small_arena_I <- as.data.frame(cbind("Male", "Small arena size", "Opportunity for selection", mean(I_Small_arena_Male_bootvar$t), quantile(I_Small_arena_Male_bootvar$t,.025, names = FALSE), quantile(I_Small_arena_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Small_pop_Is <- as.data.frame(cbind("Male", "Small population size", "Opportunity for sexual selection", mean(Is_Small_pop_Male_bootvar$t), quantile(Is_Small_pop_Male_bootvar$t,.025, names = FALSE), quantile(Is_Small_pop_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Large_pop_Is <- as.data.frame(cbind("Male", "Large population size", "Opportunity for sexual selection", mean(Is_Large_pop_Male_bootvar$t), quantile(Is_Large_pop_Male_bootvar$t,.025, names = FALSE), quantile(Is_Large_pop_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Large_arena_Is <- as.data.frame(cbind("Male", "Large arena size", "Opportunity for sexual selection", mean(Is_Large_arena_Male_bootvar$t), quantile(Is_Large_arena_Male_bootvar$t,.025, names = FALSE), quantile(Is_Large_arena_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Small_arena_Is <- as.data.frame(cbind("Male", "Small arena size", "Opportunity for sexual selection", mean(Is_Small_arena_Male_bootvar$t), quantile(Is_Small_arena_Male_bootvar$t,.025, names = FALSE), quantile(Is_Small_arena_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Small_pop_B <- as.data.frame(cbind("Male", "Small population size", "Bateman gradient", mean(B_Small_pop_Male_bootvar$t), quantile(B_Small_pop_Male_bootvar$t,.025, names = FALSE), quantile(B_Small_pop_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Large_pop_B <- as.data.frame(cbind("Male", "Large population size", "Bateman gradient", mean(B_Large_pop_Male_bootvar$t), quantile(B_Large_pop_Male_bootvar$t,.025, names = FALSE), quantile(B_Large_pop_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Large_arena_B <- as.data.frame(cbind("Male", "Large arena size", "Bateman gradient", mean(B_Large_arena_Male_bootvar$t), quantile(B_Large_arena_Male_bootvar$t,.025, names = FALSE), quantile(B_Large_arena_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Small_arena_B <- as.data.frame(cbind("Male", "Small arena size", "Bateman gradient", mean(B_Small_arena_Male_bootvar$t), quantile(B_Small_arena_Male_bootvar$t,.025, names = FALSE), quantile(B_Small_arena_Male_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Male_Small_pop_S <- as.data.frame(cbind("Male", "Small population size", "Jones index", mean(S_Small_pop_Male_bootvar$t,na.rm = T), quantile(S_Small_pop_Male_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Small_pop_Male_bootvar$t,.975, names = FALSE,na.rm = T)))
PhenVarBoot_Table_Male_Large_pop_S <- as.data.frame(cbind("Male", "Large population size", "Jones index", mean(S_Large_pop_Male_bootvar$t,na.rm = T), quantile(S_Large_pop_Male_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Large_pop_Male_bootvar$t,.975, names = FALSE,na.rm = T)))
PhenVarBoot_Table_Male_Large_arena_S <- as.data.frame(cbind("Male", "Large arena size", "Jones index", mean(S_Large_arena_Male_bootvar$t,na.rm = T), quantile(S_Large_arena_Male_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Large_arena_Male_bootvar$t,.975, names = FALSE,na.rm = T)))
PhenVarBoot_Table_Male_Small_arena_S <- as.data.frame(cbind("Male", "Small arena size", "Jones index", mean(S_Small_arena_Male_bootvar$t,na.rm = T), quantile(S_Small_arena_Male_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Small_arena_Male_bootvar$t,.975, names = FALSE,na.rm = T)))

PhenVarBoot_Table_Female_Small_pop_I <- as.data.frame(cbind("Female", "Small population size", "Opportunity for selection", mean(I_Small_pop_Female_bootvar$t), quantile(I_Small_pop_Female_bootvar$t,.025, names = FALSE), quantile(I_Small_pop_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Large_pop_I <- as.data.frame(cbind("Female", "Large population size", "Opportunity for selection", mean(I_Large_pop_Female_bootvar$t), quantile(I_Large_pop_Female_bootvar$t,.025, names = FALSE), quantile(I_Large_pop_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Large_arena_I <- as.data.frame(cbind("Female", "Large arena size", "Opportunity for selection", mean(I_Large_arena_Female_bootvar$t), quantile(I_Large_arena_Female_bootvar$t,.025, names = FALSE), quantile(I_Large_arena_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Small_arena_I <- as.data.frame(cbind("Female", "Small arena size", "Opportunity for selection", mean(I_Small_arena_Female_bootvar$t), quantile(I_Small_arena_Female_bootvar$t,.025, names = FALSE), quantile(I_Small_arena_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Small_pop_Is <- as.data.frame(cbind("Female", "Small population size", "Opportunity for sexual selection", mean(Is_Small_pop_Female_bootvar$t), quantile(Is_Small_pop_Female_bootvar$t,.025, names = FALSE), quantile(Is_Small_pop_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Large_pop_Is <- as.data.frame(cbind("Female", "Large population size", "Opportunity for sexual selection", mean(Is_Large_pop_Female_bootvar$t), quantile(Is_Large_pop_Female_bootvar$t,.025, names = FALSE), quantile(Is_Large_pop_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Large_arena_Is <- as.data.frame(cbind("Female", "Large arena size", "Opportunity for sexual selection", mean(Is_Large_arena_Female_bootvar$t), quantile(Is_Large_arena_Female_bootvar$t,.025, names = FALSE), quantile(Is_Large_arena_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Small_arena_Is <- as.data.frame(cbind("Female", "Small arena size", "Opportunity for sexual selection", mean(Is_Small_arena_Female_bootvar$t), quantile(Is_Small_arena_Female_bootvar$t,.025, names = FALSE), quantile(Is_Small_arena_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Small_pop_B <- as.data.frame(cbind("Female", "Small population size", "Bateman gradient", mean(B_Small_pop_Female_bootvar$t), quantile(B_Small_pop_Female_bootvar$t,.025, names = FALSE), quantile(B_Small_pop_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Large_pop_B <- as.data.frame(cbind("Female", "Large population size", "Bateman gradient", mean(B_Large_pop_Female_bootvar$t), quantile(B_Large_pop_Female_bootvar$t,.025, names = FALSE), quantile(B_Large_pop_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Large_arena_B <- as.data.frame(cbind("Female", "Large arena size", "Bateman gradient", mean(B_Large_arena_Female_bootvar$t), quantile(B_Large_arena_Female_bootvar$t,.025, names = FALSE), quantile(B_Large_arena_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Small_arena_B <- as.data.frame(cbind("Female", "Small arena size", "Bateman gradient", mean(B_Small_arena_Female_bootvar$t), quantile(B_Small_arena_Female_bootvar$t,.025, names = FALSE), quantile(B_Small_arena_Female_bootvar$t,.975, names = FALSE)))
PhenVarBoot_Table_Female_Small_pop_S <- as.data.frame(cbind("Female", "Small population size", "Jones index", mean(S_Small_pop_Female_bootvar$t,na.rm = T), quantile(S_Small_pop_Female_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Small_pop_Female_bootvar$t,.975, names = FALSE,na.rm = T)))
PhenVarBoot_Table_Female_Large_pop_S <- as.data.frame(cbind("Female", "Large population size", "Jones index", mean(S_Large_pop_Female_bootvar$t,na.rm = T), quantile(S_Large_pop_Female_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Large_pop_Female_bootvar$t,.975, names = FALSE,na.rm = T)))
PhenVarBoot_Table_Female_Large_arena_S <- as.data.frame(cbind("Female", "Large arena size", "Jones index", mean(S_Large_arena_Female_bootvar$t,na.rm = T), quantile(S_Large_arena_Female_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Large_arena_Female_bootvar$t,.975, names = FALSE,na.rm = T)))
PhenVarBoot_Table_Female_Small_arena_S <- as.data.frame(cbind("Female", "Small arena size", "Jones index", mean(S_Small_arena_Female_bootvar$t,na.rm = T), quantile(S_Small_arena_Female_bootvar$t,.025, names = FALSE,na.rm = T), quantile(S_Small_arena_Female_bootvar$t,.975, names = FALSE,na.rm = T)))


Table_BatemanMetrics <- as.data.frame(as.matrix(rbind(PhenVarBoot_Table_Male_Small_pop_I,PhenVarBoot_Table_Male_Large_pop_I,PhenVarBoot_Table_Male_Large_arena_I,PhenVarBoot_Table_Male_Small_arena_I,
                                                      PhenVarBoot_Table_Male_Small_pop_Is,PhenVarBoot_Table_Male_Large_pop_Is,PhenVarBoot_Table_Male_Large_arena_Is,PhenVarBoot_Table_Male_Small_arena_Is,
                                                      PhenVarBoot_Table_Male_Small_pop_B,PhenVarBoot_Table_Male_Large_pop_B,PhenVarBoot_Table_Male_Large_arena_B,PhenVarBoot_Table_Male_Small_arena_B,
                                                      PhenVarBoot_Table_Male_Small_pop_S,PhenVarBoot_Table_Male_Large_pop_S,PhenVarBoot_Table_Male_Large_arena_S,PhenVarBoot_Table_Male_Small_arena_S,
                                                      PhenVarBoot_Table_Female_Small_pop_I,PhenVarBoot_Table_Female_Large_pop_I,PhenVarBoot_Table_Female_Large_arena_I,PhenVarBoot_Table_Female_Small_arena_I,
                                                      PhenVarBoot_Table_Female_Small_pop_Is,PhenVarBoot_Table_Female_Large_pop_Is,PhenVarBoot_Table_Female_Large_arena_Is,PhenVarBoot_Table_Female_Small_arena_Is,
                                                      PhenVarBoot_Table_Female_Small_pop_B,PhenVarBoot_Table_Female_Large_pop_B,PhenVarBoot_Table_Female_Large_arena_B,PhenVarBoot_Table_Female_Small_arena_B,
                                                      PhenVarBoot_Table_Female_Small_pop_S,PhenVarBoot_Table_Female_Large_pop_S,PhenVarBoot_Table_Female_Large_arena_S,PhenVarBoot_Table_Female_Small_arena_S)),digits=2)

is.table(Table_BatemanMetrics)
colnames(Table_BatemanMetrics)[1] <- "Sex"
colnames(Table_BatemanMetrics)[2] <- "Treatment"
colnames(Table_BatemanMetrics)[3] <- "Selection metric"
colnames(Table_BatemanMetrics)[4] <- "Variance"
colnames(Table_BatemanMetrics)[5] <- "l95_CI"
colnames(Table_BatemanMetrics)[6] <- "u95_CI"
Table_BatemanMetrics[,4]=as.numeric(Table_BatemanMetrics[,4])
Table_BatemanMetrics[,5]=as.numeric(Table_BatemanMetrics[,5])
Table_BatemanMetrics[,6]=as.numeric(Table_BatemanMetrics[,6])
```

## Bootstrap mating differential on body mass

Next, we bootstrapped the mating differential on body mass.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Mating and selection differential on body mass ####
#Standardize body mass
D_data_m$stder_BM_focal=NA
D_data_m$stder_BM_focal=D_data_m$Body_mass_mg_focal-mean(D_data_m$Body_mass_mg_focal)
D_data_m$stder_BM_focal=D_data_m$stder_BM_focal/sd(D_data_m$Body_mass_mg_focal)

#Standardize body mass
D_data_f$stder_BM_focal=NA
D_data_f$stder_BM_focal=D_data_f$Body_mass_mg_focal-mean(D_data_f$Body_mass_mg_focal)
D_data_f$stder_BM_focal=D_data_f$stder_BM_focal/sd(D_data_f$Body_mass_mg_focal)

## Bootstrap mating differential on body mass ####
# Across treatments 
# Males

# Calculate relative fitness
rel_fit_males=D_data_m$m_cMS/mean(D_data_m$m_cMS,na.rm=T)

mDif_BW_males = function(dataFrame, indexVector) {
  # Calculate selection differential
  s = cov(dataFrame[indexVector, match("stder_BM_focal",names(dataFrame))],dataFrame[indexVector, match("rel_fit_males",names(dataFrame))],use="complete.obs",method = "pearson")
  return(s)
}

data_mDif=as.data.frame(cbind(rel_fit_males,D_data_m$stder_BM_focal))
names(data_mDif)[1] <- "rel_fit_males"
names(data_mDif)[2] <- "stder_BM_focal"

boot_BW_males = boot(data_mDif, mDif_BW_males, R = 10000)

# Females

# Calculate relative fitness
rel_fit_females=D_data_f$f_cMS/mean(D_data_f$f_cMS,na.rm=T)

mDif_BW_females = function(dataFrame, indexVector) { 
  # Calculate selection differential
  s = cov(dataFrame[indexVector, match("stder_BM_focal",names(dataFrame))],dataFrame[indexVector, match("rel_fit_females",names(dataFrame))],use="complete.obs",method = "pearson")
  return(s)
}

data_mDif_F=as.data.frame(cbind(rel_fit_females,D_data_f$stder_BM_focal))
names(data_mDif_F)[1] <- "rel_fit_females"
names(data_mDif_F)[2] <- "stder_BM_focal"

boot_BW_females = boot(data_mDif_F, mDif_BW_females, R = 10000)

# Mating differential for each density treatment
# Males
# Group size
# Small group
D_data_m_SG=D_data_m[D_data_m$Gr_size=='SG',]
rel_fit_males_M_SG=D_data_m_SG$m_cMS/mean(D_data_m_SG$m_cMS,na.rm=T)

data_mDif_M_SG=as.data.frame(cbind(rel_fit_males_M_SG,D_data_m_SG$stder_BM_focal))
names(data_mDif_M_SG)[1] <- "rel_fit_males"
names(data_mDif_M_SG)[2] <- "stder_BM_focal"

boot_BW_males_group_size_small = boot(data_mDif_M_SG, mDif_BW_males, R = 10000)

# Large group
D_data_m_LG=D_data_m[D_data_m$Gr_size=='LG',]
rel_fit_males_M_LG=D_data_m_LG$m_cMS/mean(D_data_m_LG$m_cMS,na.rm=T)

data_mDif_M_LG=as.data.frame(cbind(rel_fit_males_M_LG,D_data_m_LG$stder_BM_focal))
names(data_mDif_M_LG)[1] <- "rel_fit_males"
names(data_mDif_M_LG)[2] <- "stder_BM_focal"

boot_BW_males_group_size_large = boot(data_mDif_M_LG, mDif_BW_males, R = 10000)

# Arena size
# Large Arena
D_data_m_LA=D_data_m[D_data_m$Arena=='Large',]
rel_fit_males_M_LA=D_data_m_LA$m_cMS/mean(D_data_m_LA$m_cMS,na.rm=T)

data_mDif_M_LA=as.data.frame(cbind(rel_fit_males_M_LA,D_data_m_LA$stder_BM_focal))
names(data_mDif_M_LA)[1] <- "rel_fit_males"
names(data_mDif_M_LA)[2] <- "stder_BM_focal"

boot_BW_males_arena_large = boot(data_mDif_M_LA, mDif_BW_males, R = 10000)

# Small Arena
D_data_m_SA=D_data_m[D_data_m$Arena=='Small',]
rel_fit_males_M_SA=D_data_m_SA$m_cMS/mean(D_data_m_SA$m_cMS,na.rm=T)

data_mDif_M_SA=as.data.frame(cbind(rel_fit_males_M_SA,D_data_m_SA$stder_BM_focal))
names(data_mDif_M_SA)[1] <- "rel_fit_males"
names(data_mDif_M_SA)[2] <- "stder_BM_focal"

boot_BW_males_arena_small = boot(data_mDif_M_SA, mDif_BW_males, R = 10000)

# Females
# Group size
# Small group
D_data_f_SG=D_data_f[D_data_f$Gr_size=='SG',]
rel_fit_females_F_SG=D_data_f_SG$f_cMS/mean(D_data_f_SG$f_cMS,na.rm=T)

data_mDif_F_SG=as.data.frame(cbind(rel_fit_females_F_SG,D_data_f_SG$stder_BM_focal))
names(data_mDif_F_SG)[1] <- "rel_fit_females"
names(data_mDif_F_SG)[2] <- "stder_BM_focal"

boot_BW_females_group_size_small = boot(data_mDif_F_SG, mDif_BW_females, R = 10000)

# Large group
D_data_f_LG=D_data_f[D_data_f$Gr_size=='LG',]
rel_fit_females_F_LG=D_data_f_LG$f_cMS/mean(D_data_f_LG$f_cMS,na.rm=T)

data_mDif_F_LG=as.data.frame(cbind(rel_fit_females_F_LG,D_data_f_LG$stder_BM_focal))
names(data_mDif_F_LG)[1] <- "rel_fit_females"
names(data_mDif_F_LG)[2] <- "stder_BM_focal"

boot_BW_females_group_size_large = boot(data_mDif_F_LG, mDif_BW_females, R = 10000)

# Arena size
# Large Arena
D_data_f_LA=D_data_f[D_data_f$Arena=='Large',]
rel_fit_females_F_LA=D_data_f_LA$f_cMS/mean(D_data_f_LA$f_cMS,na.rm=T)

data_mDif_F_LA=as.data.frame(cbind(rel_fit_females_F_LA,D_data_f_LA$stder_BM_focal))
names(data_mDif_F_LA)[1] <- "rel_fit_females"
names(data_mDif_F_LA)[2] <- "stder_BM_focal"

boot_BW_females_arena_large = boot(data_mDif_F_LA, mDif_BW_females, R = 10000)

# Small Arena
D_data_f_SA=D_data_f[D_data_f$Arena=='Small',]
rel_fit_females_F_SA=D_data_f_SA$f_cMS/mean(D_data_f_SA$f_cMS,na.rm=T)

data_mDif_F_SA=as.data.frame(cbind(rel_fit_females_F_SA,D_data_f_SA$stder_BM_focal))
names(data_mDif_F_SA)[1] <- "rel_fit_females"
names(data_mDif_F_SA)[2] <- "stder_BM_focal"

boot_BW_females_arena_small = boot(data_mDif_F_SA, mDif_BW_females, R = 10000)

### Extract data and write results table ####
boot_data_BW_males <- as.data.frame(cbind("Male", "Body mass", "Combined", mean(boot_BW_males$t,na.rm=T), quantile(boot_BW_males$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females <- as.data.frame(cbind("Female", "Body mass", "Combined", mean(boot_BW_females$t,na.rm=T), quantile(boot_BW_females$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females$t,.975, names = FALSE,na.rm=T)))

boot_data_BW_males_group_size_small <- as.data.frame(cbind("Male", "Body mass", "Small group size", mean(boot_BW_males_group_size_small$t,na.rm=T), quantile(boot_BW_males_group_size_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_group_size_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_group_size_small <- as.data.frame(cbind("Female", "Body mass", "Small group size", mean(boot_BW_females_group_size_small$t,na.rm=T), quantile(boot_BW_females_group_size_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_group_size_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_males_group_size_large <- as.data.frame(cbind("Male", "Body mass", "Large group size", mean(boot_BW_males_group_size_large$t,na.rm=T), quantile(boot_BW_males_group_size_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_group_size_large$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_group_size_large <- as.data.frame(cbind("Female", "Body mass", "Large group size", mean(boot_BW_females_group_size_large$t,na.rm=T), quantile(boot_BW_females_group_size_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_group_size_large$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_males_arena_small <- as.data.frame(cbind("Male", "Body mass", "Small arena size", mean(boot_BW_males_arena_small$t,na.rm=T), quantile(boot_BW_males_arena_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_arena_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_arena_small <- as.data.frame(cbind("Female", "Body mass", "Small arena size", mean(boot_BW_females_arena_small$t,na.rm=T), quantile(boot_BW_females_arena_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_arena_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_males_arena_large <- as.data.frame(cbind("Male", "Body mass", "Large arena size", mean(boot_BW_males_arena_large$t,na.rm=T), quantile(boot_BW_males_arena_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_arena_large$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_arena_large <- as.data.frame(cbind("Female", "Body mass", "Large arena size", mean(boot_BW_females_arena_large$t,na.rm=T), quantile(boot_BW_females_arena_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_arena_large$t,.975, names = FALSE,na.rm=T)))

mDifBoot_Table <- as.table(as.matrix(rbind(boot_data_BW_males,boot_data_BW_females,boot_data_BW_males_group_size_small,boot_data_BW_females_group_size_small,
                                           boot_data_BW_males_group_size_large,boot_data_BW_females_group_size_large,
                                           boot_data_BW_males_arena_small,boot_data_BW_females_arena_small,
                                           boot_data_BW_males_arena_large,boot_data_BW_females_arena_large)))

is.table(mDifBoot_Table)

colnames(mDifBoot_Table)[1] <- "Sex"
colnames(mDifBoot_Table)[2] <- "Trait"
colnames(mDifBoot_Table)[3] <- "Treatment"
colnames(mDifBoot_Table)[4] <- "Coefficient"
colnames(mDifBoot_Table)[5] <- "l95_CI"
colnames(mDifBoot_Table)[6] <- "u95_CI"
mDifBoot_Table=as.data.frame.matrix(mDifBoot_Table)
mDifBoot_Table$Sex <- as.factor(as.character(mDifBoot_Table$Sex))
mDifBoot_Table$Trait <- as.factor(as.character(mDifBoot_Table$Trait))
mDifBoot_Table$Treatment <- as.factor(as.character(mDifBoot_Table$Treatment))
mDifBoot_Table$Coefficient <- round(as.numeric(as.character(mDifBoot_Table$Coefficient)),digits=2)
mDifBoot_Table$l95_CI <- round(as.numeric(as.character(mDifBoot_Table$l95_CI)),digits=2)
mDifBoot_Table$u95_CI <- round(as.numeric(as.character(mDifBoot_Table$u95_CI)),digits=2)
```

## Bootstrap selection differential on body mass

Here, we bootstrapped the selection differential on body mass.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Bootstrap selection differential on body mass ####
# Across treatments 
# Males

# Calculate relative fitness
rel_fit_males=D_data_m$m_RS/mean(D_data_m$m_RS,na.rm=T)

selDif_BW_males = function(dataFrame, indexVector) {
  # Calculate selection differential
  s = cov(dataFrame[indexVector, match("stder_BM_focal",names(dataFrame))],dataFrame[indexVector, match("rel_fit_males",names(dataFrame))],use="complete.obs",method = "pearson")
  return(s)
}

data_selDif=as.data.frame(cbind(rel_fit_males,D_data_m$stder_BM_focal))
names(data_selDif)[1] <- "rel_fit_males"
names(data_selDif)[2] <- "stder_BM_focal"

boot_BW_males = boot(data_selDif, selDif_BW_males, R = 10000)

# Females

# Calculate relative fitness
rel_fit_females=D_data_f$f_RS/mean(D_data_f$f_RS,na.rm=T)

selDif_BW_females = function(dataFrame, indexVector) { 
  # Calculate selection differential
  s = cov(dataFrame[indexVector, match("stder_BM_focal",names(dataFrame))],dataFrame[indexVector, match("rel_fit_females",names(dataFrame))],use="complete.obs",method = "pearson")
  return(s)
}

data_selDif_F=as.data.frame(cbind(rel_fit_females,D_data_f$stder_BM_focal))
names(data_selDif_F)[1] <- "rel_fit_females"
names(data_selDif_F)[2] <- "stder_BM_focal"

boot_BW_females = boot(data_selDif_F, selDif_BW_females, R = 10000)

# Selection differential for each density treatment
# Males
# Group size
# Small group
D_data_m_SG=D_data_m[D_data_m$Gr_size=='SG',]
rel_fit_males_M_SG=D_data_m_SG$m_RS/mean(D_data_m_SG$m_RS,na.rm=T)

data_selDif_M_SG=as.data.frame(cbind(rel_fit_males_M_SG,D_data_m_SG$stder_BM_focal))
names(data_selDif_M_SG)[1] <- "rel_fit_males"
names(data_selDif_M_SG)[2] <- "stder_BM_focal"

boot_BW_males_group_size_small = boot(data_selDif_M_SG, selDif_BW_males, R = 10000)

# Large group
D_data_m_LG=D_data_m[D_data_m$Gr_size=='LG',]
rel_fit_males_M_LG=D_data_m_LG$m_RS/mean(D_data_m_LG$m_RS,na.rm=T)

data_selDif_M_LG=as.data.frame(cbind(rel_fit_males_M_LG,D_data_m_LG$stder_BM_focal))
names(data_selDif_M_LG)[1] <- "rel_fit_males"
names(data_selDif_M_LG)[2] <- "stder_BM_focal"

boot_BW_males_group_size_large = boot(data_selDif_M_LG, selDif_BW_males, R = 10000)

# Arena size
# Large Arena
D_data_m_LA=D_data_m[D_data_m$Arena=='Large',]
rel_fit_males_M_LA=D_data_m_LA$m_RS/mean(D_data_m_LA$m_RS,na.rm=T)

data_selDif_M_LA=as.data.frame(cbind(rel_fit_males_M_LA,D_data_m_LA$stder_BM_focal))
names(data_selDif_M_LA)[1] <- "rel_fit_males"
names(data_selDif_M_LA)[2] <- "stder_BM_focal"

boot_BW_males_arena_large = boot(data_selDif_M_LA, selDif_BW_males, R = 10000)

# Small Arena
D_data_m_SA=D_data_m[D_data_m$Arena=='Small',]
rel_fit_males_M_SA=D_data_m_SA$m_RS/mean(D_data_m_SA$m_RS,na.rm=T)

data_selDif_M_SA=as.data.frame(cbind(rel_fit_males_M_SA,D_data_m_SA$stder_BM_focal))
names(data_selDif_M_SA)[1] <- "rel_fit_males"
names(data_selDif_M_SA)[2] <- "stder_BM_focal"

boot_BW_males_arena_small = boot(data_selDif_M_SA, selDif_BW_males, R = 10000)

# Females
# Group size
# Small group
D_data_f_SG=D_data_f[D_data_f$Gr_size=='SG',]
rel_fit_females_F_SG=D_data_f_SG$f_RS/mean(D_data_f_SG$f_RS,na.rm=T)

data_selDif_F_SG=as.data.frame(cbind(rel_fit_females_F_SG,D_data_f_SG$stder_BM_focal))
names(data_selDif_F_SG)[1] <- "rel_fit_females"
names(data_selDif_F_SG)[2] <- "stder_BM_focal"

boot_BW_females_group_size_small = boot(data_selDif_F_SG, selDif_BW_females, R = 10000)

# Large group
D_data_f_LG=D_data_f[D_data_f$Gr_size=='LG',]
rel_fit_females_F_LG=D_data_f_LG$f_RS/mean(D_data_f_LG$f_RS,na.rm=T)

data_selDif_F_LG=as.data.frame(cbind(rel_fit_females_F_LG,D_data_f_LG$stder_BM_focal))
names(data_selDif_F_LG)[1] <- "rel_fit_females"
names(data_selDif_F_LG)[2] <- "stder_BM_focal"

boot_BW_females_group_size_large = boot(data_selDif_F_LG, selDif_BW_females, R = 10000)

# Arena size
# Large Arena
D_data_f_LA=D_data_f[D_data_f$Arena=='Large',]
rel_fit_females_F_LA=D_data_f_LA$f_RS/mean(D_data_f_LA$f_RS,na.rm=T)

data_selDif_F_LA=as.data.frame(cbind(rel_fit_females_F_LA,D_data_f_LA$stder_BM_focal))
names(data_selDif_F_LA)[1] <- "rel_fit_females"
names(data_selDif_F_LA)[2] <- "stder_BM_focal"

boot_BW_females_arena_large = boot(data_selDif_F_LA, selDif_BW_females, R = 10000)

# Small Arena
D_data_f_SA=D_data_f[D_data_f$Arena=='Small',]
rel_fit_females_F_SA=D_data_f_SA$f_RS/mean(D_data_f_SA$f_RS,na.rm=T)

data_selDif_F_SA=as.data.frame(cbind(rel_fit_females_F_SA,D_data_f_SA$stder_BM_focal))
names(data_selDif_F_SA)[1] <- "rel_fit_females"
names(data_selDif_F_SA)[2] <- "stder_BM_focal"

boot_BW_females_arena_small = boot(data_selDif_F_SA, selDif_BW_females, R = 10000)

### Extract data and write results table ####
boot_data_BW_males <- as.data.frame(cbind("Male", "Body mass", "Combined", mean(boot_BW_males$t,na.rm=T), quantile(boot_BW_males$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females <- as.data.frame(cbind("Female", "Body mass", "Combined", mean(boot_BW_females$t,na.rm=T), quantile(boot_BW_females$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females$t,.975, names = FALSE,na.rm=T)))

boot_data_BW_males_group_size_small <- as.data.frame(cbind("Male", "Body mass", "Small group size", mean(boot_BW_males_group_size_small$t,na.rm=T), quantile(boot_BW_males_group_size_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_group_size_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_group_size_small <- as.data.frame(cbind("Female", "Body mass", "Small group size", mean(boot_BW_females_group_size_small$t,na.rm=T), quantile(boot_BW_females_group_size_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_group_size_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_males_group_size_large <- as.data.frame(cbind("Male", "Body mass", "large group size", mean(boot_BW_males_group_size_large$t,na.rm=T), quantile(boot_BW_males_group_size_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_group_size_large$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_group_size_large <- as.data.frame(cbind("Female", "Body mass", "large group size", mean(boot_BW_females_group_size_large$t,na.rm=T), quantile(boot_BW_females_group_size_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_group_size_large$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_males_arena_small <- as.data.frame(cbind("Male", "Body mass", "Small arena size", mean(boot_BW_males_arena_small$t,na.rm=T), quantile(boot_BW_males_arena_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_arena_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_arena_small <- as.data.frame(cbind("Female", "Body mass", "Small arena size", mean(boot_BW_females_arena_small$t,na.rm=T), quantile(boot_BW_females_arena_small$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_arena_small$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_males_arena_large <- as.data.frame(cbind("Male", "Body mass", "large arena size", mean(boot_BW_males_arena_large$t,na.rm=T), quantile(boot_BW_males_arena_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_males_arena_large$t,.975, names = FALSE,na.rm=T)))
boot_data_BW_females_arena_large <- as.data.frame(cbind("Female", "Body mass", "large arena size", mean(boot_BW_females_arena_large$t,na.rm=T), quantile(boot_BW_females_arena_large$t,.025, names = FALSE,na.rm=T), quantile(boot_BW_females_arena_large$t,.975, names = FALSE,na.rm=T)))

SelDifBoot_Table <- as.table(as.matrix(rbind(boot_data_BW_males,boot_data_BW_females,boot_data_BW_males_group_size_small,boot_data_BW_females_group_size_small,
                                             boot_data_BW_males_group_size_large,boot_data_BW_females_group_size_large,
                                             boot_data_BW_males_arena_small,boot_data_BW_females_arena_small,
                                             boot_data_BW_males_arena_large,boot_data_BW_females_arena_large)))

is.table(SelDifBoot_Table)

colnames(SelDifBoot_Table)[1] <- "Sex"
colnames(SelDifBoot_Table)[2] <- "Trait"
colnames(SelDifBoot_Table)[3] <- "Treatment"
colnames(SelDifBoot_Table)[4] <- "Coefficient"
colnames(SelDifBoot_Table)[5] <- "l95_CI"
colnames(SelDifBoot_Table)[6] <- "u95_CI"
SelDifBoot_Table=as.data.frame.matrix(SelDifBoot_Table)
SelDifBoot_Table$Sex <- as.factor(as.character(SelDifBoot_Table$Sex))
SelDifBoot_Table$Trait <- as.factor(as.character(SelDifBoot_Table$Trait))
SelDifBoot_Table$Treatment <- as.factor(as.character(SelDifBoot_Table$Treatment))
SelDifBoot_Table$Coefficient <- round(as.numeric(as.character(SelDifBoot_Table$Coefficient)),digits=2)
SelDifBoot_Table$l95_CI <- round(as.numeric(as.character(SelDifBoot_Table$l95_CI)),digits=2)
SelDifBoot_Table$u95_CI <- round(as.numeric(as.character(SelDifBoot_Table$u95_CI)),digits=2)
```

## Table 2

```{r , warning=FALSE, message=FALSE, results='hide'}
Table_2.1 <- as.data.frame(as.matrix(rbind(PhenVarBoot_Table_Female_Small_pop_I,PhenVarBoot_Table_Female_Large_pop_I,
                                                      PhenVarBoot_Table_Female_Small_pop_Is,PhenVarBoot_Table_Female_Large_pop_Is,
                                                      PhenVarBoot_Table_Female_Small_pop_B,PhenVarBoot_Table_Female_Large_pop_B,
                                                      PhenVarBoot_Table_Female_Small_pop_S,PhenVarBoot_Table_Female_Large_pop_S,
                                                      boot_data_BW_females_group_size_small,boot_data_BW_females_group_size_large,
                                                      boot_data_BW_females_group_size_small,boot_data_BW_females_group_size_large,
                                                      PhenVarBoot_Table_Male_Small_pop_I,PhenVarBoot_Table_Male_Large_pop_I,
                                                      PhenVarBoot_Table_Male_Small_pop_Is,PhenVarBoot_Table_Male_Large_pop_Is,
                                                      PhenVarBoot_Table_Male_Small_pop_B,PhenVarBoot_Table_Male_Large_pop_B,
                                                      PhenVarBoot_Table_Male_Small_pop_S,PhenVarBoot_Table_Male_Large_pop_S,
                                                      boot_data_BW_males_group_size_small,boot_data_BW_males_group_size_large,
                                                    boot_data_BW_males_group_size_small,boot_data_BW_males_group_size_large)),digits=2)


colnames(Table_2.1)[1] <- "Sex"
colnames(Table_2.1)[2] <- "Trait"
colnames(Table_2.1)[3] <- "Treatment"
colnames(Table_2.1)[4] <- "Coefficient"
colnames(Table_2.1)[5] <- "l95_CI"
colnames(Table_2.1)[6] <- "u95_CI"
Table_2.1=as.data.frame.matrix(Table_2.1)
Table_2.1$Sex <- as.factor(as.character(Table_2.1$Sex))
Table_2.1$Trait <- as.factor(as.character(Table_2.1$Trait))
Table_2.1$Treatment <- as.factor(as.character(Table_2.1$Treatment))
Table_2.1$Coefficient <- round(as.numeric(as.character(Table_2.1$Coefficient)),digits=2)
Table_2.1$l95_CI <- round(as.numeric(as.character(Table_2.1$l95_CI)),digits=2)
Table_2.1$u95_CI <- round(as.numeric(as.character(Table_2.1$u95_CI)),digits=2)

Table_2.2 <- as.data.frame(as.matrix(rbind(PhenVarBoot_Table_Female_Small_arena_I,PhenVarBoot_Table_Female_Large_arena_I,
                                                      PhenVarBoot_Table_Female_Small_arena_Is,PhenVarBoot_Table_Female_Large_arena_Is,
                                                      PhenVarBoot_Table_Female_Small_arena_B,PhenVarBoot_Table_Female_Large_arena_B,
                                                      PhenVarBoot_Table_Female_Small_arena_S,PhenVarBoot_Table_Female_Large_arena_S,
                                                      boot_data_BW_females_group_size_small,boot_data_BW_females_group_size_large,
                                                      boot_data_BW_females_group_size_small,boot_data_BW_females_group_size_large,
                                                      PhenVarBoot_Table_Male_Small_arena_I,PhenVarBoot_Table_Male_Large_arena_I,
                                                      PhenVarBoot_Table_Male_Small_arena_Is,PhenVarBoot_Table_Male_Large_arena_Is,
                                                      PhenVarBoot_Table_Male_Small_arena_B,PhenVarBoot_Table_Male_Large_arena_B,
                                                      PhenVarBoot_Table_Male_Small_arena_S,PhenVarBoot_Table_Male_Large_arena_S,
                                                      boot_data_BW_males_group_size_small,boot_data_BW_males_group_size_large,
                                                    boot_data_BW_males_group_size_small,boot_data_BW_males_group_size_large)),digits=2)


colnames(Table_2.2)[1] <- "Sex"
colnames(Table_2.2)[2] <- "Trait"
colnames(Table_2.2)[3] <- "Treatment"
colnames(Table_2.2)[4] <- "Coefficient"
colnames(Table_2.2)[5] <- "l95_CI"
colnames(Table_2.2)[6] <- "u95_CI"
Table_2.2=as.data.frame.matrix(Table_2.2)
Table_2.2$Sex <- as.factor(as.character(Table_2.2$Sex))
Table_2.2$Trait <- as.factor(as.character(Table_2.2$Trait))
Table_2.2$Treatment <- as.factor(as.character(Table_2.2$Treatment))
Table_2.2$Coefficient <- round(as.numeric(as.character(Table_2.2$Coefficient)),digits=2)
Table_2.2$l95_CI <- round(as.numeric(as.character(Table_2.2$l95_CI)),digits=2)
Table_2.2$u95_CI <- round(as.numeric(as.character(Table_2.2$u95_CI)),digits=2)
```

Table S5.1: Coefficients of variation (CV) in mating behavior for group size treatments estimated for males and females with mean and 95%CI estimated via bootstrapping.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_2.1)
```

Table S5.2: Coefficients of variation (CV) in mating behavior for arena size treatments estimated for males and females with mean and 95%CI estimated via bootstrapping.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_2.2)
```

## Plot: (sexual) selection metrics (Figure 2)

We plotted all (sexual) selection metrics by treatment and sex.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Plot: (sexual) selection metrics (Figure 2) ####
### Plot: Opportunity for selection ####
# Reorder data
plot_I_data_1=Table_BatemanMetrics[c(1,3,17,19),c(1,2,4,5,6)]
names(plot_I_data_1)[3] <- "Variance_low"
names(plot_I_data_1)[4] <- "lCI_low"
names(plot_I_data_1)[5] <- "uCI_low"
plot_I_data_2=Table_BatemanMetrics[c(2,4,18,20),c(4,5,6)]
names(plot_I_data_2)[1] <- "Variance_high"
names(plot_I_data_2)[2] <- "lCI_high"
names(plot_I_data_2)[3] <- "uCI_high"
plot_I_data=cbind(plot_I_data_1,plot_I_data_2)
plot_I_data[c(1,3),2]='Group size'
plot_I_data[c(2,4),2]='Arena size'

p16=ggplot(plot_I_data, aes(x=Variance_low, y=Variance_high, color=Sex, shape=Treatment)) +geom_abline(intercept = 0, slope = 1,size=1,linetype=2) +
  annotate(geom = "polygon", x = c(Inf, -Inf, -Inf), y = c(Inf, -Inf, Inf), fill = "grey", alpha = 0.2 )+
  geom_point(size = 5,alpha=1)+
  geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='y',aes(xmin=lCI_low, xmax=uCI_low),show.legend=FALSE) +geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='x', aes(ymin=lCI_high, ymax=uCI_high),show.legend=FALSE)+
  ylab(expression(paste('High density ',~italic("I"))))+labs(tag = "A")+xlab(expression(paste('Low density ',~italic("I"))))+
  scale_shape_manual(values=c(15, 19))+
  scale_color_manual(values=colpal2)+
  guides(shape = guide_legend(override.aes = list(size = 3.5)))+
  xlim(0.5,1.5)+ylim(0.5,1.5)+
   guides(shape = guide_legend(override.aes = list(size = 5)))+
  theme(panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.tag.position=c(0.01,0.98),
        legend.position = c(0.8, 0.25),
        legend.spacing.y = unit(0.1, 'cm'),
        legend.key=element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0,0,0,0, unit="cm"),
        legend.text = element_text(colour="black", size=11),
        axis.line.x = element_line(colour = "black", size = 1),
        axis.line.y = element_line(colour = "black", size = 1),
        axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
        axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
        axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
        axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(.3, "cm"),
        plot.margin = unit(c(0.5,0.2,0,0.2), "cm"))+guides(line = "none")

### Plot: Opportunity for sexual selection ####
# Reorder data
plot_Is_data_1=Table_BatemanMetrics[c(5,7,21,23),c(1,2,4,5,6)]
names(plot_Is_data_1)[3] <- "Variance_low"
names(plot_Is_data_1)[4] <- "lCI_low"
names(plot_Is_data_1)[5] <- "uCI_low"
plot_Is_data_2=Table_BatemanMetrics[c(6,8,22,24),c(4,5,6)]
names(plot_Is_data_2)[1] <- "Variance_high"
names(plot_Is_data_2)[2] <- "lCI_high"
names(plot_Is_data_2)[3] <- "uCI_high"
plot_Is_data=cbind(plot_Is_data_1,plot_Is_data_2)
plot_Is_data[c(1,3),2]='Group size'
plot_Is_data[c(2,4),2]='Arena size'

p17=ggplot(plot_Is_data, aes(x=Variance_low, y=Variance_high, color=Sex, shape=Treatment)) +  geom_abline(intercept = 0, slope = 1,size=1,linetype=2) +
  annotate(geom = "polygon", x = c(Inf, -Inf, -Inf), y = c(Inf, -Inf, Inf), fill = "grey", alpha = 0.2 )+
  geom_point(alpha=1,size = 5)+
  geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='y',aes(xmin=lCI_low, xmax=uCI_low)) +geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='x', aes(ymin=lCI_high, ymax=uCI_high))+
  ylab(expression(paste('High density ',~italic("I"['s']))))+labs(tag = "B")+xlab(expression(paste('Low density ',~italic("I"['s']))))+
  scale_shape_manual(values=c(15, 19))+
  scale_color_manual(values=colpal2)+
  guides(shape = guide_legend(override.aes = list(size = 3.5)))+
  xlim(0.1,0.87)+ylim(0.1,0.87)+
  theme(panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.tag.position=c(0.01,0.98),
        legend.position =  'none',
        legend.spacing.y = unit(0, 'cm'),
        legend.key=element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0,0,0,0, unit="cm"),
        legend.text = element_text(colour="black", size=10),
        legend.key.size = unit(.2, "cm"),
        axis.line.x = element_line(colour = "black", size = 1),
        axis.line.y = element_line(colour = "black", size = 1),
        axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
        axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
        axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
        axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(.3, "cm"),
        plot.margin = unit(c(0.5,0.2,0,0.2), "cm"))

### Plot: Sexual selection gradient ####
# Reorder data
plot_B_data_1=Table_BatemanMetrics[c(9,11,25,27),c(1,2,4,5,6)]
names(plot_B_data_1)[3] <- "Variance_low"
names(plot_B_data_1)[4] <- "lCI_low"
names(plot_B_data_1)[5] <- "uCI_low"
plot_B_data_2=Table_BatemanMetrics[c(10,12,26,28),c(4,5,6)]
names(plot_B_data_2)[1] <- "Variance_high"
names(plot_B_data_2)[2] <- "lCI_high"
names(plot_B_data_2)[3] <- "uCI_high"
plot_B_data=cbind(plot_B_data_1,plot_B_data_2)
plot_B_data[c(1,3),2]='Group size'
plot_B_data[c(2,4),2]='Arena size'

p18=ggplot(plot_B_data, aes(x=Variance_low, y=Variance_high, color=Sex, shape=Treatment)) +geom_abline(intercept = 0, slope = 1,size=1,linetype=2) +
  annotate(geom = "polygon", x = c(Inf, -Inf, -Inf), y = c(Inf, -Inf, Inf), fill = "grey", alpha = 0.2 )+
  geom_point(alpha=1,size = 5)+ 
  geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='y',aes(xmin=lCI_low, xmax=uCI_low)) +geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='x', aes(ymin=lCI_high, ymax=uCI_high))+
  ylab(expression(paste('High density ',~italic(symbol("b")['ss']))))+labs(tag = "C")+xlab(expression(paste('Low density ',~italic(symbol("b")['ss']))))+
  scale_shape_manual(values=c(15, 19))+
  scale_color_manual(values=colpal2)+
  guides(shape = guide_legend(override.aes = list(size = 3.5)))+
  xlim(0,1.7)+ylim(0,1.7)+
  theme(panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.tag.position=c(0.01,0.98),
        legend.position =  'none',
        legend.spacing.y = unit(0, 'cm'),
        legend.key=element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0,0,0,0, unit="cm"),
        legend.text = element_text(colour="black", size=10),
        legend.key.size = unit(.2, "cm"),
        axis.line.x = element_line(colour = "black", size = 1),
        axis.line.y = element_line(colour = "black", size = 1),
        axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
        axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
        axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
        axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(.3, "cm"),
        plot.margin = unit(c(0.5,0.2,0,0.2), "cm"))
### Plot: Jones index ####
# Reorder data
plot_Smax_data_1=Table_BatemanMetrics[c(13,15,29,31),c(1,2,4,5,6)]
names(plot_Smax_data_1)[3] <- "Variance_low"
names(plot_Smax_data_1)[4] <- "lCI_low"
names(plot_Smax_data_1)[5] <- "uCI_low"
plot_Smax_data_2=Table_BatemanMetrics[c(14,16,30,32),c(4,5,6)]
names(plot_Smax_data_2)[1] <- "Variance_high"
names(plot_Smax_data_2)[2] <- "lCI_high"
names(plot_Smax_data_2)[3] <- "uCI_high"
plot_Smax_data=cbind(plot_Smax_data_1,plot_Smax_data_2)
plot_Smax_data[c(1,3),2]='Group size'
plot_Smax_data[c(2,4),2]='Arena size'

p19=ggplot(plot_Smax_data, aes(x=Variance_low, y=Variance_high, color=Sex, shape=Treatment)) + geom_abline(intercept = 0, slope = 1,size=1,linetype=2) +
  annotate(geom = "polygon", x = c(Inf, -Inf, -Inf), y = c(Inf, -Inf, Inf), fill = "grey", alpha = 0.2 )+
  geom_point(alpha=1,size = 5)+
  geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='y',aes(xmin=lCI_low, xmax=uCI_low)) +geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='x', aes(ymin=lCI_high, ymax=uCI_high))+
  ylab(expression(paste('High density ',~italic("s'"['max']))))+labs(tag = "D")+xlab(expression(paste('Low density ',~italic("s'"['max']))))+
  scale_shape_manual(values=c(15, 19))+
  scale_color_manual(values=colpal2)+
  guides(shape = guide_legend(override.aes = list(size = 3.5)))+
  xlim(0,0.84)+ylim(0,0.84)+
  theme(panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.tag.position=c(0.01,0.98),
        legend.position =  'none',
        legend.spacing.y = unit(0, 'cm'),
        legend.key=element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0,0,0,0, unit="cm"),
        legend.text = element_text(colour="black", size=10),
        legend.key.size = unit(.2, "cm"),
        axis.line.x = element_line(colour = "black", size = 1),
        axis.line.y = element_line(colour = "black", size = 1),
        axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
        axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
        axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
        axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(.3, "cm"),
        plot.margin = unit(c(0.5,0.2,0,0.2), "cm"))

### Plot: Mating differential on body mass ####
# Reorder data
plot_mBM_data_1=mDifBoot_Table[c(3,4,9,10),c(1,3,4,5,6)]
names(plot_mBM_data_1)[3] <- "Variance_low"
names(plot_mBM_data_1)[4] <- "lCI_low"
names(plot_mBM_data_1)[5] <- "uCI_low"
plot_mBM_data_2=mDifBoot_Table[c(5,6,7,8),c(4,5,6)]
names(plot_mBM_data_2)[1] <- "Variance_high"
names(plot_mBM_data_2)[2] <- "lCI_high"
names(plot_mBM_data_2)[3] <- "uCI_high"
plot_mBM_data=cbind(plot_mBM_data_1,plot_mBM_data_2)
plot_mBM_data$Treatment=as.character(plot_mBM_data$Treatment)
plot_mBM_data[c(1,2),2]='Group size'
plot_mBM_data[c(3,4),2]='Arena size'

p20=ggplot(plot_mBM_data, aes(x=Variance_low, y=Variance_high, color=Sex, shape=Treatment)) + geom_abline(intercept = 0, slope = 1,size=1,linetype=2) +
  annotate(geom = "polygon", x = c(Inf, -Inf, -Inf), y = c(Inf, -Inf, Inf), fill = "grey", alpha = 0.2 )+
  geom_point(alpha=1,size = 5)+
  geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='y',aes(xmin=lCI_low, xmax=uCI_low)) +geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='x', aes(ymin=lCI_high, ymax=uCI_high))+
  ylab(expression(paste('High density ',~italic("m'"))))+labs(tag = "E")+xlab(expression(paste('Low density ',~italic("m'"))))+
  scale_shape_manual(values=c(15, 19))+
  scale_color_manual(values=colpal2)+
  guides(shape = guide_legend(override.aes = list(size = 3.5)))+
  xlim(-0.28,0.45)+ylim(-0.28,0.45)+
  theme(panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.tag.position=c(0.01,0.98),
        legend.position =  'none',
        legend.spacing.y = unit(0, 'cm'),
        legend.key=element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0,0,0,0, unit="cm"),
        legend.text = element_text(colour="black", size=10),
        legend.key.size = unit(.2, "cm"),
        axis.line.x = element_line(colour = "black", size = 1),
        axis.line.y = element_line(colour = "black", size = 1),
        axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
        axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
        axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
        axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(.3, "cm"),
        plot.margin = unit(c(0.5,0.2,0,0.2), "cm"))

### Plot: Selection differential on body mass ####
# Reorder data
plot_sBM_data_1=SelDifBoot_Table[c(3,4,9,10),c(1,3,4,5,6)]
names(plot_sBM_data_1)[3] <- "Variance_low"
names(plot_sBM_data_1)[4] <- "lCI_low"
names(plot_sBM_data_1)[5] <- "uCI_low"
plot_sBM_data_2=SelDifBoot_Table[c(5,6,7,8),c(4,5,6)]
names(plot_sBM_data_2)[1] <- "Variance_high"
names(plot_sBM_data_2)[2] <- "lCI_high"
names(plot_sBM_data_2)[3] <- "uCI_high"
plot_sBM_data=cbind(plot_sBM_data_1,plot_sBM_data_2)
plot_sBM_data$Treatment=as.character(plot_sBM_data$Treatment)
plot_sBM_data[c(1,2),2]='Group size'
plot_sBM_data[c(3,4),2]='Arena size'

p21=ggplot(plot_sBM_data, aes(x=Variance_low, y=Variance_high, color=Sex, shape=Treatment)) + geom_abline(intercept = 0, slope = 1,size=1,linetype=2) +
  annotate(geom = "polygon", x = c(Inf, -Inf, -Inf), y = c(Inf, -Inf, Inf), fill = "grey", alpha = 0.2 )+
  geom_point(alpha=1,size = 5)+
  geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='y',aes(xmin=lCI_low, xmax=uCI_low)) +geom_errorbar(alpha=0.5,size=1.1,width=0, orientation='x', aes(ymin=lCI_high, ymax=uCI_high))+
  ylab(expression(paste('High density ',~italic("s'"))))+labs(tag = "F")+xlab(expression(paste('Low density ',~italic("s'"))))+
  scale_shape_manual(values=c(15, 19))+
  scale_color_manual(values=colpal2)+
  guides(shape = guide_legend(override.aes = list(size = 3.5)))+
  xlim(-0.28,0.77)+ylim(-0.28,0.77)+
  theme(panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.tag.position=c(0.01,0.98),
        legend.position =  'none',
        legend.spacing.y = unit(0, 'cm'),
        legend.key=element_blank(),
        legend.title = element_blank(),
        legend.margin = margin(0,0,0,0, unit="cm"),
        legend.text = element_text(colour="black", size=10),
        legend.key.size = unit(.2, "cm"),
        axis.line.x = element_line(colour = "black", size = 1),
        axis.line.y = element_line(colour = "black", size = 1),
        axis.text.x = element_text(face="plain", color="black", size=16, angle=0),
        axis.text.y = element_text(face="plain", color="black", size=16, angle=0),
        axis.title.x = element_text(size=16,face="plain", margin = margin(r=0,10,0,0)),
        axis.title.y = element_text(size=16,face="plain", margin = margin(r=10,0,0,0)),
        axis.ticks = element_line(size = 1),
        axis.ticks.length = unit(.3, "cm"),
        plot.margin = unit(c(0.5,0.2,0,0.2), "cm"))
```

### Figure 2
```{r , warning=FALSE, message=FALSE, fig.align="left",fig.width = 7.7,fig.height=11, results='hide',fig.cap='Figure 2: Selection metrics estimated for females (blue) and males (red) under density manipulated via group (point) or arena size (square). Opportunity for selection (I; A), opportunity for sexual selection (Is; B), Bateman gradient (βss; C), Jones index (s’max; D), mating differential on body mass (m’; E) and selection differential on body mass (s’; F) with mean and 95%CI estimated via bootstrapping. Dashed lines mark equal effect size for both densities. In grey area metrics were larger under high density treatments. The x-/y-distance of means from dashed line is equal to the effect size of the treatment.',fig.fullwidth=TRUE}
# Figure 2
Figure_2<-grid.arrange(p16,p17,p18,p19,p20,p21, nrow = 3,ncol=2)
Fig_2=plot_grid(Figure_2, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
```

# Analyses for sexual selection gradients

In the following we performed additional analyses on the sexual selection gradient.

## GLM of sexual selection gradient for population size treatment
### Males
GLM of sexual selection gradient for small population size treatment
```{r , warning=FALSE, message=FALSE}
bateman1=glm(rel_m_RS~rel_m_cMS,data=D_data_Small_pop) # Small population
summary(bateman1)
```

GLM of sexual selection gradient for large population size treatment 
```{r , warning=FALSE, message=FALSE}
bateman2=glm(rel_m_RS~rel_m_cMS,data=D_data_Large_pop) # Large population
summary(bateman2)
```

### Females
GLM of sexual selection gradient for small population size treatment 
```{r , warning=FALSE, message=FALSE}
bateman3=glm(rel_f_RS~rel_f_cMS,data=D_data_Small_pop) # Small population
summary(bateman3)
```

GLM of sexual selection gradient for large population size treatment
```{r , warning=FALSE, message=FALSE}
bateman4=glm(rel_f_RS~rel_f_cMS,data=D_data_Large_pop) # Large population
summary(bateman4)
```

## GLM of sexual selection gradient for arena size treatment
### Males
GLM of sexual selection gradient for small arena size treatment
```{r , warning=FALSE, message=FALSE}
bateman5=glm(rel_m_RS~rel_m_cMS,data=D_data_Small_arena) # Small arena
summary(bateman5)
```

GLM of sexual selection gradient for large arena size treatment
```{r , warning=FALSE, message=FALSE}
bateman6=glm(rel_m_RS~rel_m_cMS,data=D_data_Large_arena) # Large arena
summary(bateman6)
```

### Females
GLM of sexual selection gradient for small arena size treatment
```{r , warning=FALSE, message=FALSE}
bateman7=glm(rel_f_RS~rel_f_cMS,data=D_data_Small_arena) # Small arena
summary(bateman7)
```

GLM of sexual selection gradient for large arena size treatment
```{r , warning=FALSE, message=FALSE}
bateman8=glm(rel_f_RS~rel_f_cMS,data=D_data_Large_arena) # Large arena
summary(bateman8)
```

## Sexual selection gradient for all treatments combined (Global Bateman gradient)

Here we analysed the sexual selection gradient across all treatments for males and females.
```{r , warning=FALSE, message=FALSE, results='hide'}
D_data$rel_f_cMS=NA
D_data$rel_f_cMS=D_data$f_cMS/mean(D_data$f_cMS,na.rm=T)
D_data$rel_f_RS=NA
D_data$rel_f_RS=D_data$f_RS/mean(D_data$f_RS,na.rm=T)
D_data$rel_m_cMS=NA
D_data$rel_m_cMS=D_data$m_cMS/mean(D_data$m_cMS,na.rm=T)
D_data$rel_m_RS=NA
D_data$rel_m_RS=D_data$m_RS/mean(D_data$m_RS,na.rm=T)
```

Global sexual selection gradient of females:
```{r , warning=FALSE, message=FALSE}
bateman9=glm(rel_f_RS~rel_f_cMS+Body_mass_mg_focal,data=D_data)
summary(bateman9)
```

Global sexual selection gradient of males:
```{r , warning=FALSE, message=FALSE}
bateman10=glm(rel_m_RS~rel_m_cMS+Body_mass_mg_focal,data=D_data)
summary(bateman10)
```

## Interaction between sexual selection gradient steepnes and sex

Next, we tested if the steepness of the global sexual selection gradient differed between the sexes.
```{r , warning=FALSE, message=FALSE, results='hide'}
data_combined=D_data
data_combined$rel_RS=NA
data_combined$rel_RS[data_combined$Sex=='M']=data_combined$rel_m_RS[data_combined$Sex=='M']
data_combined$rel_RS[data_combined$Sex=='F']=data_combined$rel_f_RS[data_combined$Sex=='F']
data_combined$rel_cMS=NA
data_combined$rel_cMS[data_combined$Sex=='M']=data_combined$rel_m_cMS[data_combined$Sex=='M']
data_combined$rel_cMS[data_combined$Sex=='F']=data_combined$rel_f_cMS[data_combined$Sex=='F']
```

Global sexual selection gradient with sex-interaction:
```{r , warning=FALSE, message=FALSE}
bateman11=glm(rel_RS~rel_cMS*Sex,data=data_combined)
summary(bateman11)
```

## Plot: Sexual selection gradient (Figure S6)

Finally, we plotted the sexual selection gradient for each sex and treatment.
```{r , warning=FALSE, message=FALSE, results='hide'}
p22<-ggplot(D_data_Small_pop, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "A")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Small group')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+ theme(legend.position="none")+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p22=p22+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

p23<-ggplot(D_data_Large_pop, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "B")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Large group')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+ theme(legend.position="none")+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p23=p23+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

p24<-ggplot(D_data_Large_arena, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "C")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Large arena')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+ theme(legend.position="none")+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p24=p24+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

p25<-ggplot(D_data_Small_arena, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "D")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Small arena')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(legend.position="none")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p25=p25+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

# Create legend
p26<-ggplot(D_data, aes(x=Total_N_MTP1, y=Total_N_Rd, color=Sex)) +
  geom_point(alpha=0.4,shape=16, size = 3, position=position_jitterdodge(jitter.height=0,jitter.width=0,dodge.width = 0)) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  scale_color_manual(values=c(colpal2[1],colpal2[2]),name = "Sex", labels = c('Females','Males'))+
  xlab('Rel. mating success')+ylab("Rel. reproductive success")+
  guides(color=guide_legend(override.aes=list(fill=NA)))+
  theme(legend.key = element_rect(fill = "transparent"))

legend_Figure_S5 <- get_legend(p26)
```

### Figure S5
```{r , warning=FALSE, message=FALSE, fig.align="left",fig.width = 8,fig.height=7, results='hide',fig.cap='Figure S5: Scatterplot of Bateman gradients (βss; relativized mating success against relativized reproductive success) for males (blue) and females (red) for group size treatment (A + B) and arena size treatment (C+ D). Slopes of liner models estimating βss indicated by solid line with predicted 95% confidence intervals.',fig.fullwidth=TRUE}
Figure_S5<-grid.arrange(p22,p23,legend_Figure_S5,p24,p25,legend_Figure_S5, nrow = 2,ncol=3, widths=c(2.3, 2.3, 0.65))
Fig_S5=plot_grid(Figure_S5, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
```

# Analyses for sexual selection gradients excluding individuals without mating success

Here we added an analysis of the sexual selection gradient excluding individuals that did not mate.
```{r , warning=FALSE, message=FALSE, results='hide'}
# Create data set excluding individuals without mating success 
D_data_noZeroMS=D_data[D_data$MatingPartners_number!=0,]

## Merge data according to treatment
# Data according to denstiy
D_data_noZeroMS_0.26=D_data_noZeroMS[D_data_noZeroMS$Treatment=='D = 0.26',]
D_data_noZeroMS_0.52=D_data_noZeroMS[D_data_noZeroMS$Treatment=='D = 0.52',]
D_data_noZeroMS_0.67=D_data_noZeroMS[D_data_noZeroMS$Treatment=='D = 0.67',]
D_data_noZeroMS_1.33=D_data_noZeroMS[D_data_noZeroMS$Treatment=='D = 1.33',]

# Reduce treatments to arena and population size
# Arena size
D_data_noZeroMS_Large_arena=rbind(D_data_noZeroMS_0.26,D_data_noZeroMS_0.52)
D_data_noZeroMS_Small_arena=rbind(D_data_noZeroMS_0.67,D_data_noZeroMS_1.33)

# Population size
D_data_noZeroMS_Small_pop=rbind(D_data_noZeroMS_0.26,D_data_noZeroMS_0.67)
D_data_noZeroMS_Large_pop=rbind(D_data_noZeroMS_0.52,D_data_noZeroMS_1.33)
```

## GLM of sexual selection gradient for population size treatment
### Males
GLM of sexual selection gradient for population size treatment for small populations
```{r , warning=FALSE, message=FALSE}
bateman1=glm(rel_m_RS~rel_m_cMS,data=D_data_noZeroMS_Small_pop) # Small population
summary(bateman1)
```

GLM of sexual selection gradient for population size treatment for large populations
```{r , warning=FALSE, message=FALSE}
bateman2=glm(rel_m_RS~rel_m_cMS,data=D_data_noZeroMS_Large_pop) # Large population
summary(bateman2)
```

### Females
GLM of sexual selection gradient for population size treatment for small populations
```{r , warning=FALSE, message=FALSE}
bateman3=glm(rel_f_RS~rel_f_cMS,data=D_data_noZeroMS_Small_pop) # Small population
summary(bateman3)
```

GLM of sexual selection gradient for population size treatment for large populations
```{r , warning=FALSE, message=FALSE}
bateman4=glm(rel_f_RS~rel_f_cMS,data=D_data_noZeroMS_Large_pop) # Large population
summary(bateman4)
```

## GLM of sexual selection gradient for arena size treatment
### Males
GLM of sexual selection gradient for arena size treatment for small arena
```{r , warning=FALSE, message=FALSE}
bateman5=glm(rel_m_RS~rel_m_cMS,data=D_data_noZeroMS_Small_arena) # Small arena
summary(bateman5)
```

GLM of sexual selection gradient for arena size treatment for large arena
```{r , warning=FALSE, message=FALSE}
bateman6=glm(rel_m_RS~rel_m_cMS,data=D_data_noZeroMS_Large_arena) # Large arena
summary(bateman6)
```

### Females
GLM of sexual selection gradient for arena size treatment for small arena
```{r , warning=FALSE, message=FALSE}
bateman7=glm(rel_f_RS~rel_f_cMS,data=D_data_noZeroMS_Small_arena) # Small arena
summary(bateman7)
```

GLM of sexual selection gradient for arena size treatment for large arena
```{r , warning=FALSE, message=FALSE}
bateman8=glm(rel_f_RS~rel_f_cMS,data=D_data_noZeroMS_Large_arena) # Large arena
summary(bateman8)
```

## Sexual selection gradient for all treatments combined (Global Bateman gradient)

Here we analysed the sexual selection gradient across all treatments for males and females.
```{r , warning=FALSE, message=FALSE, results='hide'}
D_data_noZeroMS$rel_f_cMS=NA
D_data_noZeroMS$rel_f_cMS=D_data_noZeroMS$f_cMS/mean(D_data_noZeroMS$f_cMS,na.rm=T)
D_data_noZeroMS$rel_f_RS=NA
D_data_noZeroMS$rel_f_RS=D_data_noZeroMS$f_RS/mean(D_data_noZeroMS$f_RS,na.rm=T)
D_data_noZeroMS$rel_m_cMS=NA
D_data_noZeroMS$rel_m_cMS=D_data_noZeroMS$m_cMS/mean(D_data_noZeroMS$m_cMS,na.rm=T)
D_data_noZeroMS$rel_m_RS=NA
D_data_noZeroMS$rel_m_RS=D_data_noZeroMS$m_RS/mean(D_data_noZeroMS$m_RS,na.rm=T)
```

Global sexual selection gradient of females:
```{r , warning=FALSE, message=FALSE}
bateman9=glm(rel_f_RS~rel_f_cMS+Body_mass_mg_focal,data=D_data_noZeroMS)
summary(bateman9)
```

Global sexual selection gradient of males:
```{r , warning=FALSE, message=FALSE}
bateman10=glm(rel_m_RS~rel_m_cMS+Body_mass_mg_focal,data=D_data_noZeroMS)
summary(bateman10)
```

## Interaction between sexual selection gradient steepnes and sex

Next, we tested if the steepness of the global sexual selection gradient differed between the sexes.
```{r , warning=FALSE, message=FALSE, results='hide'}
data_combined=D_data_noZeroMS
data_combined$rel_RS=NA
data_combined$rel_RS[data_combined$Sex=='M']=data_combined$rel_m_RS[data_combined$Sex=='M']
data_combined$rel_RS[data_combined$Sex=='F']=data_combined$rel_f_RS[data_combined$Sex=='F']
data_combined$rel_cMS=NA
data_combined$rel_cMS[data_combined$Sex=='M']=data_combined$rel_m_cMS[data_combined$Sex=='M']
data_combined$rel_cMS[data_combined$Sex=='F']=data_combined$rel_f_cMS[data_combined$Sex=='F']
```

Global sexual selection gradient with sex-interaction:
```{r , warning=FALSE, message=FALSE}
bateman11=glm(rel_RS~rel_cMS*Sex,data=data_combined)
summary(bateman11)
```

## Plot: Sexual selection gradient (Figure S7)

Finally, we plotted the sexual selection gradient for each sex and treatment.
```{r , warning=FALSE, message=FALSE, results='hide'}
p22<-ggplot(D_data_noZeroMS_Small_pop, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "A")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Small group')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+ theme(legend.position="none")+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p22=p22+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

p23<-ggplot(D_data_noZeroMS_Large_pop, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "B")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Large group')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+ theme(legend.position="none")+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p23=p23+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

p24<-ggplot(D_data_noZeroMS_Large_arena, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "C")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Large arena')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+ theme(legend.position="none")+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p24=p24+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

p25<-ggplot(D_data_noZeroMS_Small_arena, aes(x=rel_m_cMS, y=rel_m_RS)) +
  geom_point(alpha=0.4,shape=16, size = 3,color=colpal2[2]) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  theme(plot.tag.position=c(0.1,0.98))+
  labs(tag = "D")+xlab('Rel. mating success')+ylab("Rel. reproductive success")+ggtitle('Small arena')+ theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text=element_text(size=13),
        axis.title=element_text(size=14))+
  ylim(0,4.2)+xlim(0,3.2)+
  theme(legend.position="none")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
p25=p25+geom_point(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],alpha=0.4,shape=16, size = 3)+
  geom_smooth(aes(x=rel_f_cMS, y=rel_f_RS),color=colpal2[1],method=lm, se=TRUE,alpha=0.3)

# Create legend
p26<-ggplot(D_data_noZeroMS, aes(x=Total_N_MTP1, y=Total_N_Rd, color=Sex)) +
  geom_point(alpha=0.4,shape=16, size = 3, position=position_jitterdodge(jitter.height=0,jitter.width=0,dodge.width = 0)) +
  geom_smooth(method=lm, se=TRUE,alpha=0.3) +
  scale_color_manual(values=c(colpal2[1],colpal2[2]),name = "Sex", labels = c('Females','Males'))+
  xlab('Rel. mating success')+ylab("Rel. reproductive success")+
  guides(color=guide_legend(override.aes=list(fill=NA)))+
  theme(legend.key = element_rect(fill = "transparent"))

legend_Figure_S6 <- get_legend(p26)
```

### Figure S6
```{r , warning=FALSE, message=FALSE, fig.align="left",fig.width = 8,fig.height=7, results='hide',fig.cap='Figure S7: Scatterplot of Bateman gradients (βss; relativized mating success against relativized reproductive success) excluding individuals without mating success for males (blue) and females (red) for group size treatment (A + B) and arena size treatment (C+ D). Slopes of liner models estimating βss indicated by solid line with predicted 95% confidence intervals.',fig.fullwidth=TRUE}
Figure_S6<-grid.arrange(p22,p23,legend_Figure_S6,p24,p25,legend_Figure_S6, nrow = 2,ncol=3, widths=c(2.3, 2.3, 0.65))
Fig_S6=plot_grid(Figure_S6, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
```

# Permutation tests for treatment comparisons for (sexual) selection metrics

We used permutation tests to see if the (sexual) selection metrics differed between treatments.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Permutation tests for treatment comparisons for (sexual) selection metrics ####
### Opportunity for sexual selection (I) ####
# Arena size
# Males
Treat_diff_Male_arena_I=c(I_Small_arena_Male_bootvar$t-c(I_Large_arena_Male_bootvar$t))

t_Treat_diff_Male_arena_I=mean(Treat_diff_Male_arena_I,na.rm=TRUE)
t_Treat_diff_Male_arena_I_lower=quantile(Treat_diff_Male_arena_I,.025,na.rm=TRUE)
t_Treat_diff_Male_arena_I_upper=quantile(Treat_diff_Male_arena_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_arena$rel_m_RS,D_data_Small_arena$rel_m_RS)

diff.observed =  var(na.omit((D_data_Small_arena$rel_m_RS)))-var(na.omit((D_data_Large_arena$rel_m_RS)))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_m_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_m_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_arena_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_arena_I=c(I_Small_arena_Female_bootvar$t)-c(I_Large_arena_Female_bootvar$t)

t_Treat_diff_Female_arena_I=mean(Treat_diff_Female_arena_I,na.rm=TRUE)
t_Treat_diff_Female_arena_I_lower=quantile(Treat_diff_Female_arena_I,.025,na.rm=TRUE)
t_Treat_diff_Female_arena_I_upper=quantile(Treat_diff_Female_arena_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_arena$rel_f_RS,D_data_Small_arena$rel_f_RS)

diff.observed =  var(na.omit((D_data_Small_arena$rel_f_RS)))-var(na.omit((D_data_Large_arena$rel_f_RS)))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_f_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_f_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_arena_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Males
Treat_diff_Male_pop_I=c(I_Large_pop_Male_bootvar$t)-c(I_Small_pop_Male_bootvar$t)

t_Treat_diff_Male_pop_I=mean(Treat_diff_Male_pop_I,na.rm=TRUE)
t_Treat_diff_Male_pop_I_lower=quantile(Treat_diff_Male_pop_I,.025,na.rm=TRUE)
t_Treat_diff_Male_pop_I_upper=quantile(Treat_diff_Male_pop_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_pop$rel_m_RS,D_data_Large_pop$rel_m_RS)

diff.observed =   var(na.omit((D_data_Large_pop$rel_m_RS)))-var(na.omit((D_data_Small_pop$rel_m_RS)))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_m_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_m_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_pop_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_pop_I=c(I_Large_pop_Female_bootvar$t)-c(I_Small_pop_Female_bootvar$t)

t_Treat_diff_Female_pop_I=mean(Treat_diff_Female_pop_I,na.rm=TRUE)
t_Treat_diff_Female_pop_I_lower=quantile(Treat_diff_Female_pop_I,.025,na.rm=TRUE)
t_Treat_diff_Female_pop_I_upper=quantile(Treat_diff_Female_pop_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_pop$rel_f_RS,D_data_Large_pop$rel_f_RS)

diff.observed =   var(na.omit(c(D_data_Large_pop$rel_f_RS)))-var(na.omit(c(D_data_Small_pop$rel_f_RS)))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_f_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_f_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_pop_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Opportunity for sexual selection (Is) ####
# Arena size
# Males
Treat_diff_Male_arena_Is=c(Is_Small_arena_Male_bootvar$t)-c(Is_Large_arena_Male_bootvar$t)

t_Treat_diff_Male_arena_Is=mean(Treat_diff_Male_arena_Is,na.rm=TRUE)
t_Treat_diff_Male_arena_Is_lower=quantile(Treat_diff_Male_arena_Is,.025,na.rm=TRUE)
t_Treat_diff_Male_arena_Is_upper=quantile(Treat_diff_Male_arena_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_arena$rel_m_cMS,D_data_Small_arena$rel_m_cMS)

diff.observed =   var(na.omit(c(D_data_Small_arena$rel_m_cMS)))-var(na.omit(c(D_data_Large_arena$rel_m_cMS)))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_m_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_m_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_arena_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_arena_Is=c(Is_Small_arena_Female_bootvar$t)-c(Is_Large_arena_Female_bootvar$t)

t_Treat_diff_Female_arena_Is=mean(Treat_diff_Female_arena_Is,na.rm=TRUE)
t_Treat_diff_Female_arena_Is_lower=quantile(Treat_diff_Female_arena_Is,.025,na.rm=TRUE)
t_Treat_diff_Female_arena_Is_upper=quantile(Treat_diff_Female_arena_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_arena$rel_f_cMS,D_data_Small_arena$rel_f_cMS)

diff.observed =  var(na.omit(c(D_data_Small_arena$rel_f_cMS)))-var(na.omit(c(D_data_Large_arena$rel_f_cMS))) 
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_f_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_f_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_arena_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Males
Treat_diff_Male_pop_Is=c(Is_Large_pop_Male_bootvar$t)-c(Is_Small_pop_Male_bootvar$t)

t_Treat_diff_Male_pop_Is=mean(Treat_diff_Male_pop_Is,na.rm=TRUE)
t_Treat_diff_Male_pop_Is_lower=quantile(Treat_diff_Male_pop_Is,.025,na.rm=TRUE)
t_Treat_diff_Male_pop_Is_upper=quantile(Treat_diff_Male_pop_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_pop$rel_m_cMS,D_data_Large_pop$rel_m_cMS)

diff.observed =  var(na.omit(D_data_Large_pop$rel_m_cMS))-var(na.omit(D_data_Small_pop$rel_m_cMS),na.rm = T)
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(D_data_Small_pop$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data), length(D_data_Large_pop$rel_m_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_pop_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_pop_Is=c(Is_Large_pop_Female_bootvar$t)-c(Is_Small_pop_Female_bootvar$t)

t_Treat_diff_Female_pop_Is=mean(Treat_diff_Female_pop_Is,na.rm=TRUE)
t_Treat_diff_Female_pop_Is_lower=quantile(Treat_diff_Female_pop_Is,.025,na.rm=TRUE)
t_Treat_diff_Female_pop_Is_upper=quantile(Treat_diff_Female_pop_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_pop$rel_f_cMS,D_data_Large_pop$rel_f_cMS)

diff.observed =  var(na.omit(D_data_Large_pop$rel_f_cMS))-var(na.omit(D_data_Small_pop$rel_f_cMS))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_f_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_f_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(a.random)) - var(na.omit(b.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_pop_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Sexual selection gradient ####
# Arena size
# Males
Treat_diff_Male_arena_B=c(B_Small_arena_Male_bootvar$t)-c(B_Large_arena_Male_bootvar$t)

t_Treat_diff_Male_arena_B=mean(Treat_diff_Male_arena_B,na.rm=TRUE)
t_Treat_diff_Male_arena_B_lower=quantile(Treat_diff_Male_arena_B,.025,na.rm=TRUE)
t_Treat_diff_Male_arena_B_upper=quantile(Treat_diff_Male_arena_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_arena$rel_m_RS, D_data_Small_arena$rel_m_RS)
comb_data2=c(D_data_Large_arena$rel_m_cMS,D_data_Small_arena$rel_m_cMS)

diff.observed =  lm(D_data_Small_arena$rel_m_RS ~D_data_Small_arena$rel_m_cMS)$coefficients[2]-lm(D_data_Large_arena$rel_m_RS ~D_data_Large_arena$rel_m_cMS)$coefficients[2]
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_m_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_m_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_m_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_m_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(b.random ~d.random)$coefficients[2]-lm(a.random ~c.random)$coefficients[2] 
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_arena_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_arena_B=c(B_Small_arena_Female_bootvar$t)-c(B_Large_arena_Female_bootvar$t)

t_Treat_diff_Female_arena_B=mean(Treat_diff_Female_arena_B,na.rm=TRUE)
t_Treat_diff_Female_arena_B_lower=quantile(Treat_diff_Female_arena_B,.025,na.rm=TRUE)
t_Treat_diff_Female_arena_B_upper=quantile(Treat_diff_Female_arena_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_arena$rel_f_RS, D_data_Small_arena$rel_f_RS)
comb_data2=c(D_data_Large_arena$rel_f_cMS,D_data_Small_arena$rel_f_cMS)

diff.observed =  lm(D_data_Small_arena$rel_f_RS ~D_data_Small_arena$rel_f_cMS)$coefficients[2]-lm(D_data_Large_arena$rel_f_RS ~D_data_Large_arena$rel_f_cMS)$coefficients[2]
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_f_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_f_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_f_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_f_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(b.random ~d.random)$coefficients[2]-lm(a.random ~c.random)$coefficients[2] 
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_arena_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Males
Treat_diff_Male_pop_B=c(B_Large_pop_Male_bootvar$t)-c(B_Small_pop_Male_bootvar$t)

t_Treat_diff_Male_pop_B=mean(Treat_diff_Male_pop_B,na.rm=TRUE)
t_Treat_diff_Male_pop_B_lower=quantile(Treat_diff_Male_pop_B,.025,na.rm=TRUE)
t_Treat_diff_Male_pop_B_upper=quantile(Treat_diff_Male_pop_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_pop$rel_m_RS, D_data_Large_pop$rel_m_RS)
comb_data2=c(D_data_Small_pop$rel_m_cMS,D_data_Large_pop$rel_m_cMS)

diff.observed = lm(D_data_Large_pop$rel_m_RS ~D_data_Large_pop$rel_m_cMS)$coefficients[2]-lm(D_data_Small_pop$rel_m_RS ~D_data_Small_pop$rel_m_cMS)$coefficients[2] 
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_m_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_m_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_m_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_m_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] =  lm(b.random ~d.random)$coefficients[2]-lm(a.random ~c.random)$coefficients[2]
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_pop_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_pop_B=c(B_Large_pop_Female_bootvar$t)-c(B_Small_pop_Female_bootvar$t)

t_Treat_diff_Female_pop_B=mean(Treat_diff_Female_pop_B,na.rm=TRUE)
t_Treat_diff_Female_pop_B_lower=quantile(Treat_diff_Female_pop_B,.025,na.rm=TRUE)
t_Treat_diff_Female_pop_B_upper=quantile(Treat_diff_Female_pop_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_pop$rel_f_RS, D_data_Large_pop$rel_f_RS)
comb_data2=c(D_data_Small_pop$rel_f_cMS,D_data_Large_pop$rel_f_cMS)

diff.observed =  lm(D_data_Large_pop$rel_f_RS ~D_data_Large_pop$rel_f_cMS)$coefficients[2]-lm(D_data_Small_pop$rel_f_RS ~D_data_Small_pop$rel_f_cMS)$coefficients[2]
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_f_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_f_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_f_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_f_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(b.random ~d.random)$coefficients[2]-lm(a.random ~c.random)$coefficients[2] 
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_pop_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Jones index ####
# Arena size
# Males
Treat_diff_Male_arena_S=c(S_Small_arena_Male_bootvar$t)-c(S_Large_arena_Male_bootvar$t)

t_Treat_diff_Male_arena_S=mean(Treat_diff_Male_arena_S,na.rm=TRUE)
t_Treat_diff_Male_arena_S_lower=quantile(Treat_diff_Male_arena_S,.025,na.rm=TRUE)
t_Treat_diff_Male_arena_S_upper=quantile(Treat_diff_Male_arena_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_arena$rel_m_cMS, D_data_Small_arena$rel_m_cMS)
comb_data2=c(D_data_Large_arena$rel_m_RS, D_data_Small_arena$rel_m_RS)

diff.observed =  lm(D_data_Small_arena$rel_m_RS ~D_data_Small_arena$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Small_arena$rel_m_cMS, na.rm=TRUE))-lm(D_data_Large_arena$rel_m_RS ~D_data_Large_arena$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Large_arena$rel_m_cMS, na.rm=TRUE))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_m_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_m_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_m_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))-lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE)) 
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_arena_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_arena_S=c(S_Small_arena_Female_bootvar$t)-c(S_Large_arena_Female_bootvar$t)

t_Treat_diff_Female_arena_S=mean(Treat_diff_Female_arena_S,na.rm=TRUE)
t_Treat_diff_Female_arena_S_lower=quantile(Treat_diff_Female_arena_S,.025,na.rm=TRUE)
t_Treat_diff_Female_arena_S_upper=quantile(Treat_diff_Female_arena_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_arena$rel_f_cMS, D_data_Small_arena$rel_f_cMS)
comb_data2=c(D_data_Large_arena$rel_f_RS, D_data_Small_arena$rel_f_RS)

diff.observed =  lm(D_data_Small_arena$rel_f_RS ~D_data_Small_arena$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Small_arena$rel_f_cMS, na.rm=TRUE))-lm(D_data_Large_arena$rel_f_RS ~D_data_Large_arena$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Large_arena$rel_f_cMS, na.rm=TRUE))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_f_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_f_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_f_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_f_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))-lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE)) 
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_arena_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Males
Treat_diff_Male_pop_S=c(S_Large_pop_Male_bootvar$t)-c(S_Small_pop_Male_bootvar$t)

t_Treat_diff_Male_pop_S=mean(Treat_diff_Male_pop_S,na.rm=TRUE)
t_Treat_diff_Male_pop_S_lower=quantile(Treat_diff_Male_pop_S,.025,na.rm=TRUE)
t_Treat_diff_Male_pop_S_upper=quantile(Treat_diff_Male_pop_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_pop$rel_m_cMS, D_data_Large_pop$rel_m_cMS)
comb_data2=c(D_data_Small_pop$rel_m_RS, D_data_Large_pop$rel_m_RS)

diff.observed = lm(D_data_Large_pop$rel_m_RS ~D_data_Large_pop$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Large_pop$rel_m_cMS, na.rm=TRUE))-lm(D_data_Small_pop$rel_m_RS ~D_data_Small_pop$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Small_pop$rel_m_cMS, na.rm=TRUE))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_m_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_m_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_m_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] =  lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))-lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Male_pop_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Females
Treat_diff_Female_pop_S=c(S_Large_pop_Female_bootvar$t)-c(S_Small_pop_Female_bootvar$t)

t_Treat_diff_Female_pop_S=mean(Treat_diff_Female_pop_S,na.rm=TRUE)
t_Treat_diff_Female_pop_S_lower=quantile(Treat_diff_Female_pop_S,.025,na.rm=TRUE)
t_Treat_diff_Female_pop_S_upper=quantile(Treat_diff_Female_pop_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_pop$rel_f_cMS, D_data_Large_pop$rel_f_cMS)
comb_data2=c(D_data_Small_pop$rel_f_RS, D_data_Large_pop$rel_f_RS)

diff.observed = lm(D_data_Large_pop$rel_f_RS ~D_data_Large_pop$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Large_pop$rel_f_cMS, na.rm=TRUE))-lm(D_data_Small_pop$rel_f_RS ~D_data_Small_pop$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Small_pop$rel_f_cMS, na.rm=TRUE))
diff.observed

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_f_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_f_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_f_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_f_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] =  lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))-lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Treat_diff_Female_pop_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Extract data and write results table ####
CompTreat_Table_Male_arena_I <- as.data.frame(cbind("Male", "Arena size", "Opportunity for selection", t_Treat_diff_Male_arena_I, t_Treat_diff_Male_arena_I_lower, t_Treat_diff_Male_arena_I_upper, t_Treat_diff_Male_arena_I_p))
names(CompTreat_Table_Male_arena_I)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_pop_I <- as.data.frame(cbind("Male", "Population size", "Opportunity for selection", t_Treat_diff_Male_pop_I, t_Treat_diff_Male_pop_I_lower, t_Treat_diff_Male_pop_I_upper, t_Treat_diff_Male_pop_I_p))
names(CompTreat_Table_Male_pop_I)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_arena_Is <- as.data.frame(cbind("Male", "Arena size", "Opportunity for sexual selection", t_Treat_diff_Male_arena_Is, t_Treat_diff_Male_arena_Is_lower, t_Treat_diff_Male_arena_Is_upper, t_Treat_diff_Male_arena_Is_p))
names(CompTreat_Table_Male_arena_Is)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_pop_Is <- as.data.frame(cbind("Male", "Population size", "Opportunity for sexual selection", t_Treat_diff_Male_pop_Is, t_Treat_diff_Male_pop_Is_lower, t_Treat_diff_Male_pop_Is_upper, t_Treat_diff_Male_pop_Is_p))
names(CompTreat_Table_Male_pop_Is)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_arena_B <- as.data.frame(cbind("Male", "Arena size", "Bateman gradient", t_Treat_diff_Male_arena_B, t_Treat_diff_Male_arena_B_lower, t_Treat_diff_Male_arena_B_upper, t_Treat_diff_Male_arena_B_p))
names(CompTreat_Table_Male_arena_B)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_pop_B <- as.data.frame(cbind("Male", "Population size", "Bateman gradient", t_Treat_diff_Male_pop_B, t_Treat_diff_Male_pop_B_lower, t_Treat_diff_Male_pop_B_upper, t_Treat_diff_Male_pop_B_p))
names(CompTreat_Table_Male_pop_B)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_arena_S <- as.data.frame(cbind("Male", "Arena size", "Jones index", t_Treat_diff_Male_arena_S, t_Treat_diff_Male_arena_S_lower, t_Treat_diff_Male_arena_S_upper, t_Treat_diff_Male_arena_S_p))
names(CompTreat_Table_Male_arena_S)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Male_pop_S <- as.data.frame(cbind("Male", "Population size", "Jones index", t_Treat_diff_Male_pop_S, t_Treat_diff_Male_pop_S_lower, t_Treat_diff_Male_pop_S_upper, t_Treat_diff_Male_pop_S_p))
names(CompTreat_Table_Male_pop_S)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_arena_I <- as.data.frame(cbind("Female", "Arena size", "Opportunity for selection", t_Treat_diff_Female_arena_I, t_Treat_diff_Female_arena_I_lower, t_Treat_diff_Female_arena_I_upper, t_Treat_diff_Female_arena_I_p))
names(CompTreat_Table_Female_arena_I)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_pop_I <- as.data.frame(cbind("Female", "Population size", "Opportunity for selection", t_Treat_diff_Female_pop_I, t_Treat_diff_Female_pop_I_lower, t_Treat_diff_Female_pop_I_upper, t_Treat_diff_Female_pop_I_p))
names(CompTreat_Table_Female_pop_I)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_arena_Is <- as.data.frame(cbind("Female", "Arena size", "Opportunity for sexual selection", t_Treat_diff_Female_arena_Is, t_Treat_diff_Female_arena_Is_lower, t_Treat_diff_Female_arena_Is_upper, t_Treat_diff_Female_arena_Is_p))
names(CompTreat_Table_Female_arena_Is)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_pop_Is <- as.data.frame(cbind("Female", "Population size", "Opportunity for sexual selection", t_Treat_diff_Female_pop_Is, t_Treat_diff_Female_pop_Is_lower, t_Treat_diff_Female_pop_Is_upper, t_Treat_diff_Female_pop_Is_p))
names(CompTreat_Table_Female_pop_Is)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_arena_B <- as.data.frame(cbind("Female", "Arena size", "Bateman gradient", t_Treat_diff_Female_arena_B, t_Treat_diff_Female_arena_B_lower, t_Treat_diff_Female_arena_B_upper, t_Treat_diff_Female_arena_B_p))
names(CompTreat_Table_Female_arena_B)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_pop_B <- as.data.frame(cbind("Female", "Population size", "Bateman gradient", t_Treat_diff_Female_pop_B, t_Treat_diff_Female_pop_B_lower, t_Treat_diff_Female_pop_B_upper, t_Treat_diff_Female_pop_B_p))
names(CompTreat_Table_Female_pop_B)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_arena_S <- as.data.frame(cbind("Female", "Arena size", "Jones index", t_Treat_diff_Female_arena_S, t_Treat_diff_Female_arena_S_lower, t_Treat_diff_Female_arena_S_upper, t_Treat_diff_Female_arena_S_p))
names(CompTreat_Table_Female_arena_S)=c('V1','V2','V3','V4','V5','V6','V7')
CompTreat_Table_Female_pop_S <- as.data.frame(cbind("Female", "Population size", "Jones index", t_Treat_diff_Female_pop_S, t_Treat_diff_Female_pop_S_lower, t_Treat_diff_Female_pop_S_upper, t_Treat_diff_Female_pop_S_p))
names(CompTreat_Table_Female_pop_S)=c('V1','V2','V3','V4','V5','V6','V7')

Table_BatemanMetrics_TreatComp <- as.data.frame(as.matrix(rbind(CompTreat_Table_Male_arena_I,CompTreat_Table_Male_arena_Is,
                                                                CompTreat_Table_Male_arena_B,CompTreat_Table_Male_arena_S,
                                                                CompTreat_Table_Male_pop_I,CompTreat_Table_Male_pop_Is,
                                                                CompTreat_Table_Male_pop_B,CompTreat_Table_Male_pop_S,
                                                                CompTreat_Table_Female_arena_I,CompTreat_Table_Female_arena_Is,
                                                                CompTreat_Table_Female_arena_B,CompTreat_Table_Female_arena_S,
                                                                CompTreat_Table_Female_pop_I,CompTreat_Table_Female_pop_Is,
                                                                CompTreat_Table_Female_pop_B,CompTreat_Table_Female_pop_S
)))

Table_BatemanMetrics_TreatComp[,4]=as.numeric(Table_BatemanMetrics_TreatComp[,4])
Table_BatemanMetrics_TreatComp[,5]=as.numeric(Table_BatemanMetrics_TreatComp[,5])
Table_BatemanMetrics_TreatComp[,6]=as.numeric(Table_BatemanMetrics_TreatComp[,6])
Table_BatemanMetrics_TreatComp[,7]=as.numeric(Table_BatemanMetrics_TreatComp[,7])

colnames(Table_BatemanMetrics_TreatComp)[1] <- "Sex"
colnames(Table_BatemanMetrics_TreatComp)[2] <- "Treatment"
colnames(Table_BatemanMetrics_TreatComp)[3] <- "Selection_metric"
colnames(Table_BatemanMetrics_TreatComp)[4] <- "Variance"
colnames(Table_BatemanMetrics_TreatComp)[5] <- "l95_CI"
colnames(Table_BatemanMetrics_TreatComp)[6] <- "u95_CI"
colnames(Table_BatemanMetrics_TreatComp)[7] <- "p-value"
Table_BatemanMetrics_TreatComp[,4]=round(as.numeric(Table_BatemanMetrics_TreatComp[,4]),digits=2)
Table_BatemanMetrics_TreatComp[,5]=round(as.numeric(Table_BatemanMetrics_TreatComp[,5]),digits=2)
Table_BatemanMetrics_TreatComp[,6]=round(as.numeric(Table_BatemanMetrics_TreatComp[,6]),digits=2)
Table_BatemanMetrics_TreatComp[,7]=round(as.numeric(Table_BatemanMetrics_TreatComp[,7]),digits=3)
rownames(Table_BatemanMetrics_TreatComp) <- c()
```

Table A1: Treatment comparisons for sexual selection metrics including 95% confidence intervals. Negative effect sizes indicate larger values at lower density and positive effect sizes larger values at higher density.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_BatemanMetrics_TreatComp)
```

## Permutation test for treatment effect on mating differential of body mass 

We used permutation tests to see if the mating differential of body mass differed between treatments.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Permutation test for treatment effect on mating differential of body mass ####
# Group size
# Males
Treat_diff_male_pop=c(boot_BW_males_group_size_large$t)-c(boot_BW_males_group_size_small$t)

t_Treat_diff_male_pop=mean(Treat_diff_male_pop,na.rm=TRUE)
t_Treat_diff_male_pop_lower=quantile(Treat_diff_male_pop,.025,na.rm=TRUE)
t_Treat_diff_male_pop_upper=quantile(Treat_diff_male_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS),
               D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS))
comb_data_BM=c(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,
               D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal)

diff.observed_male_pop = cov(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS),use="complete.obs",method = "pearson") - cov(D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_male_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_male_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_male_pop = sum(abs(diff.random_male_pop) >= as.numeric(abs(diff.observed_male_pop)))/   number_of_permutations

# Females
Treat_diff_female_pop=c(boot_BW_females_group_size_large$t)-c(boot_BW_females_group_size_small$t)

t_Treat_diff_female_pop=mean(Treat_diff_female_pop,na.rm=TRUE)
t_Treat_diff_female_pop_lower=quantile(Treat_diff_female_pop,.025,na.rm=TRUE)
t_Treat_diff_female_pop_upper=quantile(Treat_diff_female_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS),
               D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS))
comb_data_BM=c(D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal,
               D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal)

diff.observed_female_pop = cov(D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_female_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_female_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}


# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_female_pop = sum(abs(diff.random_female_pop) >= as.numeric(abs(diff.observed_female_pop)))/   number_of_permutations

# Arena size
# Males
Treat_diff_male_arena=c(boot_BW_males_arena_large$t)-c(boot_BW_males_arena_small$t)

t_Treat_diff_male_arena=mean(Treat_diff_male_arena,na.rm=TRUE)
t_Treat_diff_male_arena_lower=quantile(Treat_diff_male_arena,.025,na.rm=TRUE)
t_Treat_diff_male_arena_upper=quantile(Treat_diff_male_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS),
               D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS))
comb_data_BM=c(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,
               D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal)

diff.observed_male_arena = cov(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS),use="complete.obs",method = "pearson") - cov(D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_male_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_male_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_male_arena = sum(abs(diff.random_male_arena) >= as.numeric(abs(diff.observed_male_arena)))/   number_of_permutations

# Females
Treat_diff_female_arena=c(boot_BW_females_arena_large$t)-c(boot_BW_females_arena_small$t)

t_Treat_diff_female_arena=mean(Treat_diff_female_arena,na.rm=TRUE)
t_Treat_diff_female_arena_lower=quantile(Treat_diff_female_arena,.025,na.rm=TRUE)
t_Treat_diff_female_arena_upper=quantile(Treat_diff_female_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS),
               D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS))
comb_data_BM=c(D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal,
               D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal)

diff.observed_female_arena = cov(D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_female_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_female_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}
# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_female_arena = sum(abs(diff.random_female_arena) >= as.numeric(abs(diff.observed_female_arena)))/   number_of_permutations

### Extract data and write results table ####
boot_data_BW_males_treat_group_size <-  as.data.frame(cbind("Male", "Population size", "Body mass", t_Treat_diff_male_pop, t_Treat_diff_male_pop_lower, t_Treat_diff_male_pop_upper, p_Treat_diff_male_pop))
names(boot_data_BW_males_treat_group_size)=c('V1','V2','V3','V4','V5','V6','V7')
boot_data_BW_females_treat_group_size <-  as.data.frame(cbind("Female", "Population size", "Body mass",t_Treat_diff_female_pop, t_Treat_diff_female_pop_lower, t_Treat_diff_female_pop_upper, p_Treat_diff_female_pop))
names(boot_data_BW_females_treat_group_size)=c('V1','V2','V3','V4','V5','V6','V7')
boot_data_BW_males_treat_arena <-  as.data.frame(cbind("Male", "Arena size", "Body mass", t_Treat_diff_male_arena, t_Treat_diff_male_arena_lower, t_Treat_diff_male_arena_upper, p_Treat_diff_male_arena))
names(boot_data_BW_males_treat_arena)=c('V1','V2','V3','V4','V5','V6','V7')
boot_data_BW_females_treat_arena<- as.data.frame(cbind("Female", "Arena size", "Body mass", t_Treat_diff_female_arena, t_Treat_diff_female_arena_lower, t_Treat_diff_female_arena_upper, p_Treat_diff_female_arena))
names(boot_data_BW_females_treat_arena)=c('V1','V2','V3','V4','V5','V6','V7')

Table_TreatComp_BM_MatingDif <- as.data.frame(as.matrix(rbind(boot_data_BW_males_treat_group_size,boot_data_BW_females_treat_group_size,
                                                    boot_data_BW_males_treat_arena,boot_data_BW_females_treat_arena)))

colnames(Table_TreatComp_BM_MatingDif)[1] <- "Sex"
colnames(Table_TreatComp_BM_MatingDif)[2] <- "Treatment"
colnames(Table_TreatComp_BM_MatingDif)[3] <- "Variance_component"
colnames(Table_TreatComp_BM_MatingDif)[4] <- "Variance"
colnames(Table_TreatComp_BM_MatingDif)[5] <- "l95_CI"
colnames(Table_TreatComp_BM_MatingDif)[6] <- "u95_CI"
colnames(Table_TreatComp_BM_MatingDif)[7] <- "p-value"
Table_TreatComp_BM_MatingDif[,4]=round(as.numeric(Table_TreatComp_BM_MatingDif[,4]),digits=2)
Table_TreatComp_BM_MatingDif[,5]=round(as.numeric(Table_TreatComp_BM_MatingDif[,5]),digits=2)
Table_TreatComp_BM_MatingDif[,6]=round(as.numeric(Table_TreatComp_BM_MatingDif[,6]),digits=2)
Table_TreatComp_BM_MatingDif[,7]=round(as.numeric(Table_TreatComp_BM_MatingDif[,7]),digits=3)
rownames(Table_TreatComp_BM_MatingDif) <- c()
```

Table A2: Treatment comparisons for mating differentials on body mass including 95% confidence intervals. Negative effect sizes indicate larger values at lower density and positive effect sizes larger values at higher density.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_TreatComp_BM_MatingDif)
```

## Permutation test for treatment effect on selection differential of body mass

We used permutation tests to see if the selection differential of body mass differed between treatments.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Permutation test for treatment effect on selection differential of body mass ####
# Group size
# Males
Treat_diff_male_pop=c(boot_BW_males_group_size_large$t)-c(boot_BW_males_group_size_small$t)

t_Treat_diff_male_pop=mean(Treat_diff_male_pop,na.rm=TRUE)
t_Treat_diff_male_pop_lower=quantile(Treat_diff_male_pop,.025,na.rm=TRUE)
t_Treat_diff_male_pop_upper=quantile(Treat_diff_male_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS),
               D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS))
comb_data_BM=c(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,
               D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal)

diff.observed_male_pop = cov(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS),use="complete.obs",method = "pearson") - cov(D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_male_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_male_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_male_pop = sum(abs(diff.random_male_pop) >= as.numeric(abs(diff.observed_male_pop)))/   number_of_permutations

# Females
Treat_diff_female_pop=c(boot_BW_females_group_size_large$t)-c(boot_BW_females_group_size_small$t)

t_Treat_diff_female_pop=mean(Treat_diff_female_pop,na.rm=TRUE)
t_Treat_diff_female_pop_lower=quantile(Treat_diff_female_pop,.025,na.rm=TRUE)
t_Treat_diff_female_pop_upper=quantile(Treat_diff_female_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS),
               D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS))
comb_data_BM=c(D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal,
               D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal)

diff.observed_female_pop = cov(D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_female_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_female_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}


# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_female_pop = sum(abs(diff.random_female_pop) >= as.numeric(abs(diff.observed_female_pop)))/   number_of_permutations

# Arena size
# Males
Treat_diff_male_arena=c(boot_BW_males_arena_large$t)-c(boot_BW_males_arena_small$t)

t_Treat_diff_male_arena=mean(Treat_diff_male_arena,na.rm=TRUE)
t_Treat_diff_male_arena_lower=quantile(Treat_diff_male_arena,.025,na.rm=TRUE)
t_Treat_diff_male_arena_upper=quantile(Treat_diff_male_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS),
               D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS))
comb_data_BM=c(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,
               D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal)

diff.observed_male_arena = cov(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS),use="complete.obs",method = "pearson") - cov(D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_male_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_male_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_male_arena = sum(abs(diff.random_male_arena) >= as.numeric(abs(diff.observed_male_arena)))/   number_of_permutations

# Females
Treat_diff_female_arena=c(boot_BW_females_arena_large$t)-c(boot_BW_females_arena_small$t)

t_Treat_diff_female_arena=mean(Treat_diff_female_arena,na.rm=TRUE)
t_Treat_diff_female_arena_lower=quantile(Treat_diff_female_arena,.025,na.rm=TRUE)
t_Treat_diff_female_arena_upper=quantile(Treat_diff_female_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS),
               D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS))
comb_data_BM=c(D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal,
               D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal)

diff.observed_female_arena = cov(D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_female_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_female_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}
# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Treat_diff_female_arena = sum(abs(diff.random_female_arena) >= as.numeric(abs(diff.observed_female_arena)))/   number_of_permutations

### Extract data and write results table ####
boot_data_BW_males_treat_group_size <-  as.data.frame(cbind("Male", "Population size", "Body mass", t_Treat_diff_male_pop, t_Treat_diff_male_pop_lower, t_Treat_diff_male_pop_upper, p_Treat_diff_male_pop))
names(boot_data_BW_males_treat_group_size)=c('V1','V2','V3','V4','V5','V6','V7')
boot_data_BW_females_treat_group_size <-  as.data.frame(cbind("Female", "Population size", "Body mass",t_Treat_diff_female_pop, t_Treat_diff_female_pop_lower, t_Treat_diff_female_pop_upper, p_Treat_diff_female_pop))
names(boot_data_BW_females_treat_group_size)=c('V1','V2','V3','V4','V5','V6','V7')
boot_data_BW_males_treat_arena <-  as.data.frame(cbind("Male", "Arena size", "Body mass", t_Treat_diff_male_arena, t_Treat_diff_male_arena_lower, t_Treat_diff_male_arena_upper, p_Treat_diff_male_arena))
names(boot_data_BW_males_treat_arena)=c('V1','V2','V3','V4','V5','V6','V7')
boot_data_BW_females_treat_arena<- as.data.frame(cbind("Female", "Arena size", "Body mass", t_Treat_diff_female_arena, t_Treat_diff_female_arena_lower, t_Treat_diff_female_arena_upper, p_Treat_diff_female_arena))
names(boot_data_BW_females_treat_arena)=c('V1','V2','V3','V4','V5','V6','V7')

Table_TreatComp_BM <- as.data.frame(as.matrix(rbind(boot_data_BW_males_treat_group_size,boot_data_BW_females_treat_group_size,
                                                    boot_data_BW_males_treat_arena,boot_data_BW_females_treat_arena)))

colnames(Table_TreatComp_BM)[1] <- "Sex"
colnames(Table_TreatComp_BM)[2] <- "Treatment"
colnames(Table_TreatComp_BM)[3] <- "Variance_component"
colnames(Table_TreatComp_BM)[4] <- "Variance"
colnames(Table_TreatComp_BM)[5] <- "l95_CI"
colnames(Table_TreatComp_BM)[6] <- "u95_CI"
colnames(Table_TreatComp_BM)[7] <- "p-value"
Table_TreatComp_BM[,4]=round(as.numeric(Table_TreatComp_BM[,4]),digits=2)
Table_TreatComp_BM[,5]=round(as.numeric(Table_TreatComp_BM[,5]),digits=2)
Table_TreatComp_BM[,6]=round(as.numeric(Table_TreatComp_BM[,6]),digits=2)
Table_TreatComp_BM[,7]=round(as.numeric(Table_TreatComp_BM[,7]),digits=3)
rownames(Table_TreatComp_BM) <- c()
```

Table A3: Treatment comparisons for selection differentials on body mass including 95% confidence intervals. Negative effect sizes indicate larger values at lower density and positive effect sizes larger values at higher density.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_TreatComp_BM)
```

# Permutation tests for sex comparisons of (sexual) selection metrics

We used permutation tests to see if the (sexual) selection metrics differed between the sexes.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Permutation tests for sex comparisons of (sexual) selection metrics ####
### Opportunity for sexual selection (I) ####
# Arena size
# Large
Sex_diff_Large_arena_I=c(I_Large_arena_Male_bootvar$t)-c(I_Large_arena_Female_bootvar$t)

t_Sex_diff_Large_arena_I=mean(Sex_diff_Large_arena_I,na.rm=TRUE)
t_Sex_diff_Large_arena_I_lower=quantile(Sex_diff_Large_arena_I,.025,na.rm=TRUE)
t_Sex_diff_Large_arena_I_upper=quantile(Sex_diff_Large_arena_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_arena$rel_m_RS,D_data_Large_arena$rel_f_RS)

diff.observed = var(na.omit((D_data_Large_arena$rel_m_RS))) - var(na.omit((D_data_Large_arena$rel_f_RS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_m_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_f_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_arena_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Small
Sex_diff_Small_arena_I=c(I_Small_arena_Male_bootvar$t)-c(I_Small_arena_Female_bootvar$t)

t_Sex_diff_Small_arena_I=mean(Sex_diff_Small_arena_I,na.rm=TRUE)
t_Sex_diff_Small_arena_I_lower=quantile(Sex_diff_Small_arena_I,.025,na.rm=TRUE)
t_Sex_diff_Small_arena_I_upper=quantile(Sex_diff_Small_arena_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_arena$rel_m_RS,D_data_Small_arena$rel_f_RS)

diff.observed = var(na.omit((D_data_Small_arena$rel_m_RS))) - var(na.omit((D_data_Small_arena$rel_f_RS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_m_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_f_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_arena_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Small
Sex_diff_Small_pop_I=c(I_Small_pop_Male_bootvar$t)-c(I_Small_pop_Female_bootvar$t)

t_Sex_diff_Small_pop_I=mean(Sex_diff_Small_pop_I,na.rm=TRUE)
t_Sex_diff_Small_pop_I_lower=quantile(Sex_diff_Small_pop_I,.025,na.rm=TRUE)
t_Sex_diff_Small_pop_I_upper=quantile(Sex_diff_Small_pop_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_pop$rel_m_RS,D_data_Small_pop$rel_f_RS)

diff.observed = var(na.omit((D_data_Small_pop$rel_m_RS))) - var(na.omit((D_data_Small_pop$rel_f_RS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_m_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_f_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_pop_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Large
Sex_diff_Large_pop_I=c(I_Large_pop_Male_bootvar$t)-c(I_Large_pop_Female_bootvar$t)

t_Sex_diff_Large_pop_I=mean(Sex_diff_Large_pop_I,na.rm=TRUE)
t_Sex_diff_Large_pop_I_lower=quantile(Sex_diff_Large_pop_I,.025,na.rm=TRUE)
t_Sex_diff_Large_pop_I_upper=quantile(Sex_diff_Large_pop_I,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_pop$rel_m_RS,D_data_Large_pop$rel_f_RS)

diff.observed = var(na.omit(c(D_data_Large_pop$rel_m_RS))) - var(na.omit(c(D_data_Large_pop$rel_f_RS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_m_RS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_f_RS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_pop_I_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Opportnity for sexual selection (Is) ####
# Arena size
# Small
Sex_diff_Small_arena_Is=c(Is_Small_arena_Male_bootvar$t)-c(Is_Small_arena_Female_bootvar$t)

t_Sex_diff_Small_arena_Is=mean(Sex_diff_Small_arena_Is,na.rm=TRUE)
t_Sex_diff_Small_arena_Is_lower=quantile(Sex_diff_Small_arena_Is,.025,na.rm=TRUE)
t_Sex_diff_Small_arena_Is_upper=quantile(Sex_diff_Small_arena_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_arena$rel_m_cMS,D_data_Small_arena$rel_f_cMS)

diff.observed = var(na.omit(c(D_data_Small_arena$rel_m_cMS))) - var(na.omit(c(D_data_Small_arena$rel_f_cMS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_m_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_arena$rel_f_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_arena_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Large
Sex_diff_Large_arena_Is=c(Is_Large_arena_Male_bootvar$t)-c(Is_Large_arena_Female_bootvar$t)

t_Sex_diff_Large_arena_Is=mean(Sex_diff_Large_arena_Is,na.rm=TRUE)
t_Sex_diff_Large_arena_Is_lower=quantile(Sex_diff_Large_arena_Is,.025,na.rm=TRUE)
t_Sex_diff_Large_arena_Is_upper=quantile(Sex_diff_Large_arena_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_arena$rel_m_cMS,D_data_Large_arena$rel_f_cMS)

diff.observed = var(na.omit(c(D_data_Large_arena$rel_m_cMS))) - var(na.omit(c(D_data_Large_arena$rel_f_cMS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_m_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_arena$rel_f_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_arena_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Small
Sex_diff_Small_pop_Is=c(Is_Small_pop_Male_bootvar$t)-c(Is_Small_pop_Female_bootvar$t)

t_Sex_diff_Small_pop_Is=mean(Sex_diff_Small_pop_Is,na.rm=TRUE)
t_Sex_diff_Small_pop_Is_lower=quantile(Sex_diff_Small_pop_Is,.025,na.rm=TRUE)
t_Sex_diff_Small_pop_Is_upper=quantile(Sex_diff_Small_pop_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Small_pop$rel_m_cMS,D_data_Small_pop$rel_f_cMS)

diff.observed = var(na.omit(c(D_data_Small_pop$rel_m_cMS))) - var(na.omit(c(D_data_Small_pop$rel_f_cMS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_m_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Small_pop$rel_f_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_pop_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Large
Sex_diff_Large_pop_Is=c(Is_Large_pop_Male_bootvar$t)-c(Is_Large_pop_Female_bootvar$t)

t_Sex_diff_Large_pop_Is=mean(Sex_diff_Large_pop_Is,na.rm=TRUE)
t_Sex_diff_Large_pop_Is_lower=quantile(Sex_diff_Large_pop_Is,.025,na.rm=TRUE)
t_Sex_diff_Large_pop_Is_upper=quantile(Sex_diff_Large_pop_Is,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data=c(D_data_Large_pop$rel_m_cMS,D_data_Large_pop$rel_f_cMS)

diff.observed = var(na.omit(c(D_data_Large_pop$rel_m_cMS))) - var(na.omit(c(D_data_Large_pop$rel_f_cMS)))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_m_cMS)), TRUE)
  b.random = sample (na.omit(comb_data), length(c(D_data_Large_pop$rel_f_cMS)), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = var(na.omit(b.random)) - var(na.omit(a.random))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_pop_Is_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Sexual selection gradient ####
# Arena size
# Large
Sex_diff_Large_arena_B=c(B_Large_arena_Male_bootvar$t)-c(B_Large_arena_Female_bootvar$t)

t_Sex_diff_Large_arena_B=mean(Sex_diff_Large_arena_B,na.rm=TRUE)
t_Sex_diff_Large_arena_B_lower=quantile(Sex_diff_Large_arena_B,.025,na.rm=TRUE)
t_Sex_diff_Large_arena_B_upper=quantile(Sex_diff_Large_arena_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_arena$rel_m_RS, D_data_Large_arena$rel_f_RS)
comb_data2=c(D_data_Large_arena$rel_m_cMS,D_data_Large_arena$rel_f_cMS)

diff.observed = lm(D_data_Large_arena$rel_m_RS ~D_data_Large_arena$rel_m_cMS)$coefficients[2] - lm(D_data_Large_arena$rel_f_RS ~D_data_Large_arena$rel_f_cMS)$coefficients[2]

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_m_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_m_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_m_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_m_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(a.random ~c.random)$coefficients[2] - lm(b.random ~d.random)$coefficients[2]
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_arena_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Small
Sex_diff_Small_arena_B=c(B_Small_arena_Male_bootvar$t)-c(B_Small_arena_Female_bootvar$t)

t_Sex_diff_Small_arena_B=mean(Sex_diff_Small_arena_B,na.rm=TRUE)
t_Sex_diff_Small_arena_B_lower=quantile(Sex_diff_Small_arena_B,.025,na.rm=TRUE)
t_Sex_diff_Small_arena_B_upper=quantile(Sex_diff_Small_arena_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_arena$rel_m_RS, D_data_Small_arena$rel_f_RS)
comb_data2=c(D_data_Small_arena$rel_m_cMS,D_data_Small_arena$rel_f_cMS)

diff.observed = lm(D_data_Small_arena$rel_m_RS ~D_data_Small_arena$rel_m_cMS)$coefficients[2] - lm(D_data_Small_arena$rel_f_RS ~D_data_Small_arena$rel_f_cMS)$coefficients[2]

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_m_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_f_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_m_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_f_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(a.random ~c.random)$coefficients[2] - lm(b.random ~d.random)$coefficients[2]
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_arena_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Large
Sex_diff_Large_pop_B=c(B_Large_pop_Male_bootvar$t)-c(B_Large_pop_Female_bootvar$t)

t_Sex_diff_Large_pop_B=mean(Sex_diff_Large_pop_B,na.rm=TRUE)
t_Sex_diff_Large_pop_B_lower=quantile(Sex_diff_Large_pop_B,.025,na.rm=TRUE)
t_Sex_diff_Large_pop_B_upper=quantile(Sex_diff_Large_pop_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_pop$rel_m_RS, D_data_Large_pop$rel_f_RS)
comb_data2=c(D_data_Large_pop$rel_m_cMS,D_data_Large_pop$rel_f_cMS)

diff.observed = lm(D_data_Large_pop$rel_m_RS ~D_data_Large_pop$rel_m_cMS)$coefficients[2] - lm(D_data_Large_pop$rel_f_RS ~D_data_Large_pop$rel_f_cMS)$coefficients[2]

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_m_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_m_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_m_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_m_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(a.random ~c.random)$coefficients[2] - lm(b.random ~d.random)$coefficients[2]
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_pop_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Small
Sex_diff_Small_pop_B=c(B_Small_pop_Male_bootvar$t)-c(B_Small_pop_Female_bootvar$t)

t_Sex_diff_Small_pop_B=mean(Sex_diff_Small_pop_B,na.rm=TRUE)
t_Sex_diff_Small_pop_B_lower=quantile(Sex_diff_Small_pop_B,.025,na.rm=TRUE)
t_Sex_diff_Small_pop_B_upper=quantile(Sex_diff_Small_pop_B,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_pop$rel_m_RS, D_data_Small_pop$rel_f_RS)
comb_data2=c(D_data_Small_pop$rel_m_cMS,D_data_Small_pop$rel_f_cMS)

diff.observed = lm(D_data_Small_pop$rel_m_RS ~D_data_Small_pop$rel_m_cMS)$coefficients[2] - lm(D_data_Small_pop$rel_f_RS ~D_data_Small_pop$rel_f_cMS)$coefficients[2]

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_m_RS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_f_RS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_m_cMS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_f_cMS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(a.random ~c.random)$coefficients[2] - lm(b.random ~d.random)$coefficients[2]
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_pop_B_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Jones index ####
# Arena size
# Large
Sex_diff_Large_arena_S=c(S_Large_arena_Male_bootvar$t)-c(S_Large_arena_Female_bootvar$t)

t_Sex_diff_Large_arena_S=mean(Sex_diff_Large_arena_S,na.rm=TRUE)
t_Sex_diff_Large_arena_S_lower=quantile(Sex_diff_Large_arena_S,.025,na.rm=TRUE)
t_Sex_diff_Large_arena_S_upper=quantile(Sex_diff_Large_arena_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_arena$rel_m_cMS, D_data_Large_arena$rel_f_cMS)
comb_data2=c(D_data_Large_arena$rel_m_RS, D_data_Large_arena$rel_f_RS)

diff.observed = lm(D_data_Large_arena$rel_m_RS ~D_data_Large_arena$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Large_arena$rel_m_cMS, na.rm=TRUE)) - lm(D_data_Large_arena$rel_f_RS ~D_data_Large_arena$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Large_arena$rel_f_cMS, na.rm=TRUE))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_arena$rel_f_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_m_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_arena$rel_f_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE)) - lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_arena_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Small
Sex_diff_Small_arena_S=c(S_Small_arena_Male_bootvar$t)-c(S_Small_arena_Female_bootvar$t)

t_Sex_diff_Small_arena_S=mean(Sex_diff_Small_arena_S,na.rm=TRUE)
t_Sex_diff_Small_arena_S_lower=quantile(Sex_diff_Small_arena_S,.025,na.rm=TRUE)
t_Sex_diff_Small_arena_S_upper=quantile(Sex_diff_Small_arena_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_arena$rel_m_cMS, D_data_Small_arena$rel_f_cMS)
comb_data2=c(D_data_Small_arena$rel_m_RS, D_data_Small_arena$rel_f_RS)

diff.observed = lm(D_data_Small_arena$rel_m_RS ~D_data_Small_arena$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Small_arena$rel_m_cMS, na.rm=TRUE)) - lm(D_data_Small_arena$rel_f_RS ~D_data_Small_arena$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Small_arena$rel_f_cMS, na.rm=TRUE))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_arena$rel_f_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_m_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_arena$rel_f_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE)) - lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_arena_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Population size
# Small
Sex_diff_Small_pop_S=c(S_Small_pop_Male_bootvar$t)-c(S_Small_pop_Female_bootvar$t)

t_Sex_diff_Small_pop_S=mean(Sex_diff_Small_pop_S,na.rm=TRUE)
t_Sex_diff_Small_pop_S_lower=quantile(Sex_diff_Small_pop_S,.025,na.rm=TRUE)
t_Sex_diff_Small_pop_S_upper=quantile(Sex_diff_Small_pop_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Small_pop$rel_m_cMS, D_data_Small_pop$rel_f_cMS)
comb_data2=c(D_data_Small_pop$rel_m_RS, D_data_Small_pop$rel_f_RS)

diff.observed = lm(D_data_Small_pop$rel_m_RS ~D_data_Small_pop$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Small_pop$rel_m_cMS, na.rm=TRUE)) - lm(D_data_Small_pop$rel_f_RS ~D_data_Small_pop$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Small_pop$rel_f_cMS, na.rm=TRUE))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Small_pop$rel_f_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_m_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Small_pop$rel_f_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE)) - lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Small_pop_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

# Large
Sex_diff_Large_pop_S=c(S_Large_pop_Male_bootvar$t)-c(S_Large_pop_Female_bootvar$t)

t_Sex_diff_Large_pop_S=mean(Sex_diff_Large_pop_S,na.rm=TRUE)
t_Sex_diff_Large_pop_S_lower=quantile(Sex_diff_Large_pop_S,.025,na.rm=TRUE)
t_Sex_diff_Large_pop_S_upper=quantile(Sex_diff_Large_pop_S,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data1=c(D_data_Large_pop$rel_m_cMS, D_data_Large_pop$rel_f_cMS)
comb_data2=c(D_data_Large_pop$rel_m_RS, D_data_Large_pop$rel_f_RS)

diff.observed = lm(D_data_Large_pop$rel_m_RS ~D_data_Large_pop$rel_m_cMS)$coefficients[2]*sqrt(var(D_data_Large_pop$rel_m_cMS, na.rm=TRUE)) - lm(D_data_Large_pop$rel_f_RS ~D_data_Large_pop$rel_f_cMS)$coefficients[2]*sqrt(var(D_data_Large_pop$rel_f_cMS, na.rm=TRUE))

number_of_permutations = 100000
diff.random = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_m_cMS), TRUE)
  b.random = sample (na.omit(comb_data1), length(D_data_Large_pop$rel_f_cMS), TRUE)
  c.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_f_RS), TRUE)
  d.random = sample (na.omit(comb_data2), length(D_data_Large_pop$rel_m_RS), TRUE)
  
  # Null (permuated) difference
  diff.random[i] = lm(c.random ~a.random)$coefficients[2]*sqrt(var(a.random, na.rm=TRUE)) - lm(d.random ~b.random)$coefficients[2]*sqrt(var(b.random, na.rm=TRUE))
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

t_Sex_diff_Large_pop_S_p = sum(abs(diff.random) >= as.numeric(abs(diff.observed)))/   number_of_permutations

### Extract data and write results table ####
CompSex_Table_Large_arena_I <- as.data.frame(cbind("Large arena size", "Opportunity for selection", t_Sex_diff_Large_arena_I, t_Sex_diff_Large_arena_I_lower, t_Sex_diff_Large_arena_I_upper, t_Sex_diff_Large_arena_I_p))
names(CompSex_Table_Large_arena_I)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_pop_I <- as.data.frame(cbind("Large population size", "Opportunity for selection", t_Sex_diff_Large_pop_I, t_Sex_diff_Large_pop_I_lower, t_Sex_diff_Large_pop_I_upper, t_Sex_diff_Large_pop_I_p))
names(CompSex_Table_Large_pop_I)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_arena_Is <- as.data.frame(cbind("Large arena size", "Opportunity for sexual selection", t_Sex_diff_Large_arena_Is, t_Sex_diff_Large_arena_Is_lower, t_Sex_diff_Large_arena_Is_upper, t_Sex_diff_Large_arena_Is_p))
names(CompSex_Table_Large_arena_Is)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_pop_Is <- as.data.frame(cbind("Large population size", "Opportunity for sexual selection", t_Sex_diff_Large_pop_Is, t_Sex_diff_Large_pop_Is_lower, t_Sex_diff_Large_pop_Is_upper, t_Sex_diff_Large_pop_Is_p))
names(CompSex_Table_Large_pop_Is)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_arena_B <- as.data.frame(cbind("Large arena size", "Bateman gradient", t_Sex_diff_Large_arena_B, t_Sex_diff_Large_arena_B_lower, t_Sex_diff_Large_arena_B_upper, t_Sex_diff_Large_arena_B_p))
names(CompSex_Table_Large_arena_B)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_pop_B <- as.data.frame(cbind("Large population size", "Bateman gradient", t_Sex_diff_Large_pop_B, t_Sex_diff_Large_pop_B_lower, t_Sex_diff_Large_pop_B_upper, t_Sex_diff_Large_pop_B_p))
names(CompSex_Table_Large_pop_B)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_arena_S <- as.data.frame(cbind("Large arena size", "Jones index", t_Sex_diff_Large_arena_S, t_Sex_diff_Large_arena_S_lower, t_Sex_diff_Large_arena_S_upper, t_Sex_diff_Large_arena_S_p))
names(CompSex_Table_Large_arena_S)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Large_pop_S <- as.data.frame(cbind("Large population size", "Jones index", t_Sex_diff_Large_pop_S, t_Sex_diff_Large_pop_S_lower, t_Sex_diff_Large_pop_S_upper, t_Sex_diff_Large_pop_S_p))
names(CompSex_Table_Large_pop_S)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_arena_I <- as.data.frame(cbind("Small arena size", "Opportunity for selection", t_Sex_diff_Small_arena_I, t_Sex_diff_Small_arena_I_lower, t_Sex_diff_Small_arena_I_upper, t_Sex_diff_Small_arena_I_p))
names(CompSex_Table_Small_arena_I)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_pop_I <- as.data.frame(cbind("Small population size", "Opportunity for selection", t_Sex_diff_Small_pop_I, t_Sex_diff_Small_pop_I_lower, t_Sex_diff_Small_pop_I_upper, t_Sex_diff_Small_pop_I_p))
names(CompSex_Table_Small_pop_I)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_arena_Is <- as.data.frame(cbind("Small arena size", "Opportunity for sexual selection", t_Sex_diff_Small_arena_Is, t_Sex_diff_Small_arena_Is_lower, t_Sex_diff_Small_arena_Is_upper, t_Sex_diff_Small_arena_Is_p))
names(CompSex_Table_Small_arena_Is)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_pop_Is <- as.data.frame(cbind("Small population size", "Opportunity for sexual selection", t_Sex_diff_Small_pop_Is, t_Sex_diff_Small_pop_Is_lower, t_Sex_diff_Small_pop_Is_upper, t_Sex_diff_Small_pop_Is_p))
names(CompSex_Table_Small_pop_Is)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_arena_B <- as.data.frame(cbind("Small arena size", "Bateman gradient", t_Sex_diff_Small_arena_B, t_Sex_diff_Small_arena_B_lower, t_Sex_diff_Small_arena_B_upper, t_Sex_diff_Small_arena_B_p))
names(CompSex_Table_Small_arena_B)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_pop_B <- as.data.frame(cbind("Small population size", "Bateman gradient", t_Sex_diff_Small_pop_B, t_Sex_diff_Small_pop_B_lower, t_Sex_diff_Small_pop_B_upper, t_Sex_diff_Small_pop_B_p))
names(CompSex_Table_Small_pop_B)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_arena_S <- as.data.frame(cbind("Small arena size", "Jones index", t_Sex_diff_Small_arena_S, t_Sex_diff_Small_arena_S_lower, t_Sex_diff_Small_arena_S_upper, t_Sex_diff_Small_arena_S_p))
names(CompSex_Table_Small_arena_S)=c('V1','V2','V3','V4','V5','V6')
CompSex_Table_Small_pop_S <- as.data.frame(cbind("Small population size", "Jones index", t_Sex_diff_Small_pop_S, t_Sex_diff_Small_pop_S_lower, t_Sex_diff_Small_pop_S_upper, t_Sex_diff_Small_pop_S_p))
names(CompSex_Table_Small_pop_S)=c('V1','V2','V3','V4','V5','V6')

Table_BatemanMetrics_SexComp <- as.data.frame(as.matrix(rbind(CompSex_Table_Small_pop_I,CompSex_Table_Small_pop_Is,
                                                              CompSex_Table_Small_pop_B,CompSex_Table_Small_pop_S,
                                                              CompSex_Table_Large_pop_I,CompSex_Table_Large_pop_Is,
                                                              CompSex_Table_Large_pop_B,CompSex_Table_Large_pop_S,
                                                              CompSex_Table_Large_arena_I,CompSex_Table_Large_arena_Is,
                                                              CompSex_Table_Large_arena_B,CompSex_Table_Large_arena_S,
                                                              CompSex_Table_Small_arena_I,CompSex_Table_Small_arena_Is,
                                                              CompSex_Table_Small_arena_B,CompSex_Table_Small_arena_S)))

colnames(Table_BatemanMetrics_SexComp)[1] <- "Treatment"
colnames(Table_BatemanMetrics_SexComp)[2] <- "Selection_metric"
colnames(Table_BatemanMetrics_SexComp)[3] <- "Variance"
colnames(Table_BatemanMetrics_SexComp)[4] <- "l95_CI"
colnames(Table_BatemanMetrics_SexComp)[5] <- "u95_CI"
colnames(Table_BatemanMetrics_SexComp)[6] <- "p-value"
Table_BatemanMetrics_SexComp[,3]=round(as.numeric(Table_BatemanMetrics_SexComp[,3]),digits=2)
Table_BatemanMetrics_SexComp[,4]=round(as.numeric(Table_BatemanMetrics_SexComp[,4]),digits=2)
Table_BatemanMetrics_SexComp[,5]=round(as.numeric(Table_BatemanMetrics_SexComp[,5]),digits=2)
Table_BatemanMetrics_SexComp[,6]=round(as.numeric(Table_BatemanMetrics_SexComp[,6]),digits=3)
rownames(Table_BatemanMetrics_SexComp) <- c()
```

Table A4: Sex comparisons for (sexual) selection metrics including 95% confidence intervals. Negative effect sizes indicate larger values at lower density and positive effect sizes larger values at higher density.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_BatemanMetrics_SexComp)
```

## Permutation test for sex differences in mating differential on body mass

We used permutation tests to see if the mating differential of body mass differed between the sexes.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Permutation test for sex differences in mating differential on body mass ####
# Population size
# Small
Sex_diff_Small_pop=c(boot_BW_males_group_size_small$t)-c(boot_BW_females_group_size_small$t)

t_Sex_diff_Small_pop=mean(Sex_diff_Small_pop,na.rm=TRUE)
t_Sex_diff_Small_pop_lower=quantile(Sex_diff_Small_pop,.025,na.rm=TRUE)
t_Sex_diff_Small_pop_upper=quantile(Sex_diff_Small_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS),
               D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS))
comb_data_BM=c(D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal,
               D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal)

diff.observed_Small_pop = cov(D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_Small_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_Small_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_Small_pop = sum((diff.random_Small_pop) >= as.numeric((diff.observed_Small_pop)))/   number_of_permutations

# Population size
# Large
Sex_diff_large_pop=c(boot_BW_males_group_size_large$t)-c(boot_BW_females_group_size_large$t)

t_Sex_diff_large_pop=mean(p_Sex_diff_Small_pop,na.rm=TRUE)
t_Sex_diff_large_pop_lower=quantile(p_Sex_diff_Small_pop,.025,na.rm=TRUE)
t_Sex_diff_large_pop_upper=quantile(p_Sex_diff_Small_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS),
               D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS))
comb_data_BM=c(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,
               D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal)

diff.observed_large_pop = cov(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_large_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_large_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_large_pop = sum(abs(diff.random_large_pop) >= as.numeric(abs(diff.observed_large_pop)))/   number_of_permutations

# Arena size
# Large
Sex_diff_large_arena=c(boot_BW_males_arena_large$t)-c(boot_BW_females_arena_large$t)

t_Sex_diff_large_arena=mean(Sex_diff_large_arena,na.rm=TRUE)
t_Sex_diff_large_arena_lower=quantile(Sex_diff_large_arena,.025,na.rm=TRUE)
t_Sex_diff_large_arena_upper=quantile(Sex_diff_large_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS),
               D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS))
comb_data_BM=c(D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal,
               D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal)

diff.observed_large_arena = cov(D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_large_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Large',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Large',]$m_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Large',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Large',]$f_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_large_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_large_arena = sum(abs(diff.random_large_arena) >= as.numeric(abs(diff.observed_large_arena)))/   number_of_permutations

# Small
Sex_diff_small_arena=c(boot_BW_males_arena_small$t)-c(boot_BW_females_arena_small$t)

t_Sex_diff_small_arena=mean(Sex_diff_small_arena,na.rm=TRUE)
t_Sex_diff_small_arena_lower=quantile(Sex_diff_small_arena,.025,na.rm=TRUE)
t_Sex_diff_small_arena_upper=quantile(Sex_diff_small_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS),
               D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS))
comb_data_BM=c(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,
               D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal)

diff.observed_small_arena = cov(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_small_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Small',]$m_cMS/mean(D_data_m[D_data_m$Arena=='Small',]$m_cMS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Small',]$f_cMS/mean(D_data_f[D_data_f$Arena=='Small',]$f_cMS))), TRUE)
  
  # Null (permuated) difference
  diff.random_small_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}
# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_small_arena = sum(abs(diff.random_small_arena) >= as.numeric(abs(diff.observed_small_arena)))/   number_of_permutations

### Extract data and write results table ####
boot_data_matingDif_small_group_size <-  as.data.frame(cbind("Small group size", "Mating differential", t_Sex_diff_Small_pop, t_Sex_diff_Small_pop_lower, t_Sex_diff_Small_pop_upper, p_Sex_diff_Small_pop))
names(boot_data_matingDif_small_group_size)=c('V1','V2','V3','V4','V5','V6')
boot_data_matingDif_large_group_size <-  as.data.frame(cbind("Large group size", "Mating differential", t_Sex_diff_large_pop, t_Sex_diff_large_pop_lower, t_Sex_diff_large_pop_upper, p_Sex_diff_large_pop))
names(boot_data_matingDif_large_group_size)=c('V1','V2','V3','V4','V5','V6')
boot_data_matingDif_large_arena <-  as.data.frame(cbind("Large arena size", "Mating differential", t_Sex_diff_large_arena, t_Sex_diff_large_arena_lower, t_Sex_diff_large_arena_upper, p_Sex_diff_large_arena))
names(boot_data_matingDif_large_arena)=c('V1','V2','V3','V4','V5','V6')
boot_data_matingDif_small_arena_size <-  as.data.frame(cbind("Small arena size", "Mating differential", t_Sex_diff_small_arena, t_Sex_diff_small_arena_lower, t_Sex_diff_small_arena_upper, p_Sex_diff_small_arena))
names(boot_data_matingDif_small_arena_size)=c('V1','V2','V3','V4','V5','V6')

Table_SexComp_BM_MatDif <- as.data.frame(as.matrix(rbind(boot_data_matingDif_small_group_size,boot_data_matingDif_large_group_size,
                                                  boot_data_matingDif_large_arena,boot_data_matingDif_small_arena_size)))

colnames(Table_SexComp_BM_MatDif)[1] <- "Treatment"
colnames(Table_SexComp_BM_MatDif)[2] <- "Variance_component"
colnames(Table_SexComp_BM_MatDif)[3] <- "Variance"
colnames(Table_SexComp_BM_MatDif)[4] <- "l95_CI"
colnames(Table_SexComp_BM_MatDif)[5] <- "u95_CI"
colnames(Table_SexComp_BM_MatDif)[6] <- "p-value"
Table_SexComp_BM_MatDif[,3]=round(as.numeric(Table_SexComp_BM_MatDif[,3]),digits=2)
Table_SexComp_BM_MatDif[,4]=round(as.numeric(Table_SexComp_BM_MatDif[,4]),digits=2)
Table_SexComp_BM_MatDif[,5]=round(as.numeric(Table_SexComp_BM_MatDif[,5]),digits=2)
Table_SexComp_BM_MatDif[,6]=round(as.numeric(Table_SexComp_BM_MatDif[,6]),digits=3)
rownames(Table_SexComp_BM_MatDif) <- c()
```

Table A5: Sex comparisons for mating differentials on body mass including 95% confidence intervals. Negative effect sizes indicate larger values at lower density and positive effect sizes larger values at higher density.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_SexComp_BM_MatDif)
```

## Permutation test for sex differences in selection differential on body mass

We used permutation tests to see if the selection differential of body mass differed between the sexes.
```{r , warning=FALSE, message=FALSE, results='hide'}
## Permutation test for sex differences in selection differential on body mass ####
# Population size
# Small
Sex_diff_Small_pop=c(boot_BW_males_group_size_small$t)-c(boot_BW_females_group_size_small$t)

t_Sex_diff_Small_pop=mean(Sex_diff_Small_pop,na.rm=TRUE)
t_Sex_diff_Small_pop_lower=quantile(Sex_diff_Small_pop,.025,na.rm=TRUE)
t_Sex_diff_Small_pop_upper=quantile(Sex_diff_Small_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS),
               D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS))
comb_data_BM=c(D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal,
               D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal)

diff.observed_Small_pop = cov(D_data_m[D_data_m$Gr_size=='SG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Gr_size=='SG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_Small_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='SG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='SG',]$m_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='SG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='SG',]$f_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_Small_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_Small_pop = sum((diff.random_Small_pop) >= as.numeric((diff.observed_Small_pop)))/   number_of_permutations

# Large
Sex_diff_large_pop=c(boot_BW_males_group_size_large$t)-c(boot_BW_females_group_size_large$t)

t_Sex_diff_large_pop=mean(Sex_diff_large_pop,na.rm=TRUE)
t_Sex_diff_large_pop_lower=quantile(Sex_diff_large_pop,.025,na.rm=TRUE)
t_Sex_diff_large_pop_upper=quantile(Sex_diff_large_pop,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS),
               D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS))
comb_data_BM=c(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,
               D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal)

diff.observed_large_pop = cov(D_data_m[D_data_m$Gr_size=='LG',]$stder_BM_focal,D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Gr_size=='LG',]$stder_BM_focal,D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_large_pop = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Gr_size=='LG',]$m_RS/mean(D_data_m[D_data_m$Gr_size=='LG',]$m_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Gr_size=='LG',]$f_RS/mean(D_data_f[D_data_f$Gr_size=='LG',]$f_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_large_pop[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_large_pop = sum(abs(diff.random_large_pop) >= as.numeric(abs(diff.observed_large_pop)))/   number_of_permutations

# Arena size
# Large
Sex_diff_large_arena=c(boot_BW_males_arena_large$t)-c(boot_BW_females_arena_large$t)

t_Sex_diff_large_arena=mean(Sex_diff_large_arena,na.rm=TRUE)
t_Sex_diff_large_arena_lower=quantile(Sex_diff_large_arena,.025,na.rm=TRUE)
t_Sex_diff_large_arena_upper=quantile(Sex_diff_large_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS),
               D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS))
comb_data_BM=c(D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal,
               D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal)

diff.observed_large_arena = cov(D_data_m[D_data_m$Arena=='Large',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Arena=='Large',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_large_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Large',]$m_RS/mean(D_data_m[D_data_m$Arena=='Large',]$m_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Large',]$f_RS/mean(D_data_f[D_data_f$Arena=='Large',]$f_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_large_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}

# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_large_arena = sum(abs(diff.random_large_arena) >= as.numeric(abs(diff.observed_large_arena)))/   number_of_permutations

# Small
Sex_diff_small_arena=c(boot_BW_males_arena_small$t)-c(boot_BW_females_arena_small$t)

t_Sex_diff_small_arena=mean(Sex_diff_small_arena,na.rm=TRUE)
t_Sex_diff_small_arena_lower=quantile(Sex_diff_small_arena,.025,na.rm=TRUE)
t_Sex_diff_small_arena_upper=quantile(Sex_diff_small_arena,.975,na.rm=TRUE)

# Permutation test to calculate p value
comb_data_RS=c(D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS),
               D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS))
comb_data_BM=c(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,
               D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal)

diff.observed_small_arena = cov(D_data_m[D_data_m$Arena=='Small',]$stder_BM_focal,D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS),use="complete.obs",method = "pearson") - cov(D_data_f[D_data_f$Arena=='Small',]$stder_BM_focal,D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS),use="complete.obs",method = "pearson") 

number_of_permutations = 100000
diff.random_small_arena = NULL
for (i in 1 : number_of_permutations) {
  
  # Sample from the combined dataset
  a.random = sample (na.omit(comb_data_RS), length(c(D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS))), TRUE)
  b.random = sample (na.omit(comb_data_BM), length(c(D_data_m[D_data_m$Arena=='Small',]$m_RS/mean(D_data_m[D_data_m$Arena=='Small',]$m_RS))), TRUE)
  c.random = sample (na.omit(comb_data_RS), length(c(D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS))), TRUE)
  d.random = sample (na.omit(comb_data_BM), length(c(D_data_f[D_data_f$Arena=='Small',]$f_RS/mean(D_data_f[D_data_f$Arena=='Small',]$f_RS))), TRUE)
  
  # Null (permuated) difference
  diff.random_small_arena[i] = cov(b.random,a.random,use="complete.obs",method = "pearson") - cov(d.random,c.random,use="complete.obs",method = "pearson")
}
# P-value is the fraction of how many times the permuted difference is equal or more extreme than the observed difference

p_Sex_diff_small_arena = sum(abs(diff.random_small_arena) >= as.numeric(abs(diff.observed_small_arena)))/   number_of_permutations

### Extract data and write results table ####
boot_data_matingDif_small_group_size <-  as.data.frame(cbind("Small group size", "Mating differential", t_Sex_diff_Small_pop, t_Sex_diff_Small_pop_lower, t_Sex_diff_Small_pop_upper, p_Sex_diff_Small_pop))
names(boot_data_matingDif_small_group_size)=c('V1','V2','V3','V4','V5','V6')
boot_data_matingDif_large_group_size <-  as.data.frame(cbind("Large group size", "Mating differential", t_Sex_diff_large_pop, t_Sex_diff_large_pop_lower, t_Sex_diff_large_pop_upper, p_Sex_diff_large_pop))
names(boot_data_matingDif_large_group_size)=c('V1','V2','V3','V4','V5','V6')
boot_data_matingDif_large_arena <-  as.data.frame(cbind("Large arena size", "Mating differential", t_Sex_diff_large_arena, t_Sex_diff_large_arena_lower, t_Sex_diff_large_arena_upper, p_Sex_diff_large_arena))
names(boot_data_matingDif_large_arena)=c('V1','V2','V3','V4','V5','V6')
boot_data_matingDif_small_arena_size <-  as.data.frame(cbind("Small arena size", "Mating differential", t_Sex_diff_small_arena, t_Sex_diff_small_arena_lower, t_Sex_diff_small_arena_upper, p_Sex_diff_small_arena))
names(boot_data_matingDif_small_arena_size)=c('V1','V2','V3','V4','V5','V6')

Table_SexComp_BM <- as.data.frame(as.matrix(rbind(boot_data_matingDif_small_group_size,boot_data_matingDif_large_group_size,
                                                  boot_data_matingDif_large_arena,boot_data_matingDif_small_arena_size)))

colnames(Table_SexComp_BM)[1] <- "Treatment"
colnames(Table_SexComp_BM)[2] <- "Variance_component"
colnames(Table_SexComp_BM)[3] <- "Variance"
colnames(Table_SexComp_BM)[4] <- "l95_CI"
colnames(Table_SexComp_BM)[5] <- "u95_CI"
colnames(Table_SexComp_BM)[6] <- "p-value"
Table_SexComp_BM[,3]=round(as.numeric(Table_SexComp_BM[,3]),digits=2)
Table_SexComp_BM[,4]=round(as.numeric(Table_SexComp_BM[,4]),digits=2)
Table_SexComp_BM[,5]=round(as.numeric(Table_SexComp_BM[,5]),digits=2)
Table_SexComp_BM[,6]=round(as.numeric(Table_SexComp_BM[,6]),digits=3)
rownames(Table_SexComp_BM) <- c()
```

Table A6: Sex comparisons for selection differentials on body mass including 95% confidence intervals. Negative effect sizes indicate larger values at lower density and positive effect sizes larger values at higher density.
```{r , warning=FALSE, message=FALSE, layout="l-body-outset"}
kable(Table_SexComp_BM)
```
